# VS Code 插件开发指南

## 1. 概述

VS Code 插件是扩展 VS Code 功能的一种方式，通过插件可以添加新的功能、修改现有功能或自定义 VS Code 的外观和行为。

### 1.1 插件类型

VS Code 插件主要分为以下几种类型：

- **核心扩展**：扩展 VS Code 的核心功能，如语言支持、调试器、主题等
- **工具扩展**：提供开发工具，如 GitLens、ESLint 等
- **框架扩展**：为特定框架提供支持，如 React、Vue、Angular 等
- **主题扩展**：自定义 VS Code 的颜色主题和图标主题
- **语言扩展**：为特定编程语言提供语法高亮、智能提示、代码格式化等支持
- **调试扩展**：为特定调试器提供支持
- **Web 扩展**：可以在浏览器中运行的扩展
- **Remote 扩展**：用于远程开发的扩展

### 1.2 插件架构

VS Code 插件基于 Node.js 开发，使用 JavaScript 或 TypeScript 编写。插件的架构主要包括：

- **扩展宿主**：运行插件代码的 Node.js 进程
- **主进程**：VS Code 的主进程，负责管理窗口和 UI
- **渲染进程**：负责渲染 VS Code 的 UI
- **API**：VS Code 提供的扩展 API，用于与 VS Code 交互

### 1.3 插件 API

VS Code 提供了丰富的 API，用于扩展 VS Code 的功能：

- **命令 API**：注册和执行命令
- **编辑器 API**：操作编辑器内容和状态
- **窗口 API**：显示通知、输入框、消息框等
- **工作区 API**：操作文件和文件夹
- **语言 API**：提供语言支持
- **调试 API**：提供调试支持
- **主题 API**：自定义主题
- **视图 API**：创建自定义视图

## 2. 开发环境准备

### 2.1 安装 Node.js

VS Code 插件开发需要 Node.js 环境，建议安装最新的 LTS 版本。

- **下载地址**：https://nodejs.org/
- **版本要求**：Node.js 16.x 或更高版本

安装完成后，验证 Node.js 和 npm 安装：

```bash
node --version
npm --version
```

### 2.2 安装 VS Code

确保安装了最新版本的 VS Code：

- **下载地址**：https://code.visualstudio.com/

### 2.3 安装 Yeoman 和 VS Code 扩展生成器

VS Code 提供了 Yeoman 生成器，用于快速创建插件项目：

```bash
npm install -g yo generator-code
```

### 2.4 安装 TypeScript（可选）

推荐使用 TypeScript 开发 VS Code 插件，提供更好的类型检查和智能提示：

```bash
npm install -g typescript
```

## 3. 创建第一个插件

### 3.1 使用 Yeoman 生成器创建项目

运行 Yeoman 生成器，创建一个新的插件项目：

```bash
yo code
```

按照提示选择项目类型和配置：

1. 选择项目类型：
   - `New Extension (TypeScript)`：使用 TypeScript 开发的扩展
   - `New Extension (JavaScript)`：使用 JavaScript 开发的扩展
   - `New Extension Pack`：扩展包，包含多个扩展
   - `New Language Support`：语言支持扩展
   - `New Theme`：主题扩展
   - `New Color Theme`：颜色主题扩展
   - `New Icon Theme`：图标主题扩展
   - `New Web Extension`：Web 扩展
   - `New Notebook Renderer`：笔记本渲染器

2. 输入扩展名称、标识符、描述、发布者等信息
3. 选择是否初始化 Git 仓库
4. 选择是否使用 Webpack 打包

### 3.2 项目结构

生成的插件项目结构如下：

```
my-extension/
├── .vscode/              # VS Code 配置
│   ├── extensions.json    # 推荐扩展
│   ├── launch.json         # 调试配置
│   ├── settings.json       # 工作区设置
│   └── tasks.json          # 任务配置
├── src/                   # 源代码
│   └── extension.ts        # 扩展入口文件
├── test/                  # 测试代码
├── .gitignore              # Git 忽略文件
├── CHANGELOG.md           # 变更日志
├── LICENSE                # 许可证
├── package.json           # 扩展配置
├── README.md              # 扩展说明
├── tsconfig.json          # TypeScript 配置
├── tsconfig.node.json     # Node.js TypeScript 配置
├── vsc-extension-quickstart.md # 快速开始指南
└── webpack.config.js      # Webpack 配置（如果使用 Webpack）
```

### 3.3 核心文件说明

#### 3.3.1 package.json

`package.json` 是插件的配置文件，包含插件的元数据和扩展点配置：

```json
{
  "name": "my-extension",
  "displayName": "My Extension",
  "description": "A sample VS Code extension",
  "version": "0.0.1",
  "engines": {
    "vscode": "^1.74.0"
  },
  "categories": [
    "Other"
  ],
  "activationEvents": [
    "onCommand:my-extension.helloWorld"
  ],
  "main": "out/extension.js",
  "contributes": {
    "commands": [
      {
        "command": "my-extension.helloWorld",
        "title": "Hello World"
      }
    ]
  },
  "scripts": {
    "vscode:prepublish": "npm run compile",
    "compile": "tsc -p ./",
    "watch": "tsc -watch -p ./",
    "pretest": "npm run compile && npm run lint",
    "lint": "eslint src --ext ts",
    "test": "node ./out/test/runTest.js"
  },
  "devDependencies": {
    "@types/vscode": "^1.74.0",
    "@types/glob": "^8.0.0",
    "@types/mocha": "^10.0.0",
    "@types/node": "16.x",
    "@typescript-eslint/eslint-plugin": "^5.45.0",
    "@typescript-eslint/parser": "^5.45.0",
    "eslint": "^8.28.0",
    "glob": "^8.0.3",
    "mocha": "^10.1.0",
    "typescript": "^4.9.3",
    "@vscode/test-electron": "^2.2.0"
  }
}
```

#### 3.3.2 extension.ts

`extension.ts` 是插件的入口文件，包含插件的激活和停用逻辑：

```typescript
import * as vscode from 'vscode';

export function activate(context: vscode.ExtensionContext) {
  console.log('Congratulations, your extension "my-extension" is now active!');

  let disposable = vscode.commands.registerCommand('my-extension.helloWorld', () => {
    vscode.window.showInformationMessage('Hello World from My Extension!');
  });

  context.subscriptions.push(disposable);
}

export function deactivate() {
  console.log('Your extension "my-extension" is now deactivated!');
}
```

## 4. 插件配置

### 4.1 activationEvents

`activationEvents` 定义了插件的激活事件，当这些事件发生时，插件会被激活：

| 事件类型 | 描述 | 示例 |
|----------|------|------|
| `onCommand` | 当命令被执行时 | `onCommand:my-extension.helloWorld` |
| `onLanguage` | 当打开特定语言的文件时 | `onLanguage:javascript` |
| `onView` | 当自定义视图被打开时 | `onView:my-view` |
| `onUri` | 当 VS Code 被特定 URI 激活时 | `onUri` |
| `onWebviewPanel` | 当 Webview 面板被创建或显示时 | `onWebviewPanel:my-panel` |
| `onStartupFinished` | 当 VS Code 启动完成时 | `onStartupFinished` |
| `*` | 当 VS Code 启动时 | `*` |

### 4.2 contributes

`contributes` 定义了插件贡献的功能，如命令、视图、快捷键等：

#### 4.2.1 commands

注册命令：

```json
"contributes": {
  "commands": [
    {
      "command": "my-extension.helloWorld",
      "title": "Hello World",
      "category": "My Extension"
    }
  ]
}
```

#### 4.2.2 menus

将命令添加到菜单：

```json
"contributes": {
  "menus": {
    "editor/context": [
      {
        "when": "editorHasSelection",
        "command": "my-extension.helloWorld",
        "group": "navigation"
      }
    ]
  }
}
```

#### 4.2.3 keybindings

为命令添加快捷键：

```json
"contributes": {
  "keybindings": [
    {
      "command": "my-extension.helloWorld",
      "key": "ctrl+shift+h",
      "mac": "cmd+shift+h",
      "when": "editorTextFocus"
    }
  ]
}
```

#### 4.2.4 views

创建自定义视图：

```json
"contributes": {
  "views": {
    "explorer": [
      {
        "id": "myView",
        "name": "My View",
        "icon": "$(file-directory)",
        "contextualTitle": "My View"
      }
    ]
  }
}
```

#### 4.2.5 snippets

贡献代码片段：

```json
"contributes": {
  "snippets": [
    {
      "language": "javascript",
      "path": "./snippets/javascript.json"
    }
  ]
}
```

## 5. 核心 API

### 5.1 命令 API

注册和执行命令：

```typescript
// 注册命令
const disposable = vscode.commands.registerCommand('my-extension.helloWorld', () => {
  vscode.window.showInformationMessage('Hello World!');
});

// 执行命令
vscode.commands.executeCommand('editor.action.formatDocument');
```

### 5.2 窗口 API

显示通知、输入框、消息框等：

```typescript
// 显示信息通知
vscode.window.showInformationMessage('Information message');

// 显示警告通知
vscode.window.showWarningMessage('Warning message');

// 显示错误通知
vscode.window.showErrorMessage('Error message');

// 显示输入框
const result = await vscode.window.showInputBox({
  prompt: 'Enter your name',
  placeHolder: 'Name'
});

// 显示消息框
const selection = await vscode.window.showQuickPick(['Option 1', 'Option 2', 'Option 3']);
```

### 5.3 编辑器 API

操作编辑器内容和状态：

```typescript
// 获取当前活动编辑器
const editor = vscode.window.activeTextEditor;
if (editor) {
  // 获取文档
  const document = editor.document;
  // 获取选区
  const selection = editor.selection;
  // 获取选区内的文本
  const text = document.getText(selection);
  // 替换选区内的文本
  await editor.edit(editBuilder => {
    editBuilder.replace(selection, 'Replaced text');
  });
}
```

### 5.4 工作区 API

操作文件和文件夹：

```typescript
// 获取当前工作区文件夹
const workspaceFolders = vscode.workspace.workspaceFolders;
if (workspaceFolders) {
  const folder = workspaceFolders[0];
  const folderPath = folder.uri.fsPath;
}

// 读取文件
const fileUri = vscode.Uri.file('/path/to/file.txt');
const content = await vscode.workspace.fs.readFile(fileUri);

// 写入文件
await vscode.workspace.fs.writeFile(fileUri, Buffer.from('New content'));

// 监听文件变化
const watcher = vscode.workspace.createFileSystemWatcher('**/*.ts');
watcher.onDidChange(uri => {
  console.log(`File changed: ${uri.fsPath}`);
});
```

### 5.5 配置 API

读取和修改配置：

```typescript
// 读取配置
const config = vscode.workspace.getConfiguration('myExtension');
const settingValue = config.get<string>('settingName');

// 修改配置
await vscode.workspace.getConfiguration('myExtension').update('settingName', 'newValue', vscode.ConfigurationTarget.Global);
```

## 6. 插件功能开发

### 6.1 注册命令

在 `extension.ts` 中注册命令：

```typescript
export function activate(context: vscode.ExtensionContext) {
  // 注册命令
  const disposable = vscode.commands.registerCommand('my-extension.helloWorld', () => {
    vscode.window.showInformationMessage('Hello World from My Extension!');
  });

  // 将命令添加到订阅列表，以便在插件停用时分销
  context.subscriptions.push(disposable);
}
```

### 6.2 创建自定义视图

创建一个 TreeView：

1. 定义树项接口：

```typescript
interface TreeItem extends vscode.TreeItem {
  children?: TreeItem[];
}
```

2. 创建树数据提供者：

```typescript
class TreeDataProvider implements vscode.TreeDataProvider<TreeItem> {
  private _onDidChangeTreeData = new vscode.EventEmitter<TreeItem | undefined>();
  readonly onDidChangeTreeData = this._onDidChangeTreeData.event;

  getTreeItem(element: TreeItem): vscode.TreeItem {
    return element;
  }

  getChildren(element?: TreeItem): Thenable<TreeItem[]> {
    if (!element) {
      // 返回根节点
      return Promise.resolve([
        {
          label: 'Item 1',
          collapsibleState: vscode.TreeItemCollapsibleState.Collapsed
        },
        {
          label: 'Item 2',
          collapsibleState: vscode.TreeItemCollapsibleState.Collapsed
        }
      ]);
    }
    // 返回子节点
    return Promise.resolve([
      {
        label: `${element.label} - Child 1`,
        collapsibleState: vscode.TreeItemCollapsibleState.None
      },
      {
        label: `${element.label} - Child 2`,
        collapsibleState: vscode.TreeItemCollapsibleState.None
      }
    ]);
  }

  refresh(): void {
    this._onDidChangeTreeData.fire(undefined);
  }
}
```

3. 注册 TreeView：

```typescript
export function activate(context: vscode.ExtensionContext) {
  const treeDataProvider = new TreeDataProvider();
  vscode.window.registerTreeDataProvider('myView', treeDataProvider);
  
  // 注册刷新命令
  vscode.commands.registerCommand('myView.refresh', () => {
    treeDataProvider.refresh();
  });
}
```

### 6.3 创建 Webview

创建一个 Webview 面板：

```typescript
export function activate(context: vscode.ExtensionContext) {
  // 注册命令，创建 Webview 面板
  vscode.commands.registerCommand('my-extension.showWebview', () => {
    const panel = vscode.window.createWebviewPanel(
      'myWebview', // 面板类型
      'My Webview', // 面板标题
      vscode.ViewColumn.One, // 显示位置
      {
        enableScripts: true, // 启用脚本
        retainContextWhenHidden: true // 隐藏时保留上下文
      }
    );

    // 设置 Webview 内容
    panel.webview.html = getWebviewContent();

    // 监听 Webview 消息
    panel.webview.onDidReceiveMessage(
      message => {
        switch (message.command) {
          case 'alert':
            vscode.window.showInformationMessage(message.text);
            return;
        }
      },
      undefined,
      context.subscriptions
    );
  });
}

function getWebviewContent() {
  return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Webview</title>
    <style>
        body { padding: 10px; }
        button { padding: 5px 10px; }
    </style>
</head>
<body>
    <h1>Hello Webview!</h1>
    <button id="btn">Click Me</button>
    <script>
        const vscode = acquireVsCodeApi();
        document.getElementById('btn').addEventListener('click', () => {
            vscode.postMessage({ command: 'alert', text: 'Button clicked!' });
        });
    </script>
</body>
</html>`;
}
```

## 7. 调试和测试

### 7.1 调试插件

1. 打开插件项目
2. 按下 `F5` 或点击「运行和调试」面板中的「启动调试」按钮
3. VS Code 会启动一个新的扩展宿主窗口
4. 在扩展宿主窗口中测试插件功能
5. 在原窗口中查看调试输出和设置断点

### 7.2 测试插件

VS Code 插件支持使用 Mocha 进行测试：

1. 在 `test` 目录中创建测试文件
2. 运行测试：
   ```bash
   npm test
   ```

## 8. 发布插件

### 8.1 安装发布工具

```bash
npm install -g vsce
```

### 8.2 创建发布者

在 VS Code 市场注册账号，并创建发布者：

```bash
vsce create-publisher <publisher-name>
```

### 8.3 打包插件

```bash
vsce package
```

这将生成一个 `.vsix` 文件，用于发布或手动安装。

### 8.4 发布插件

```bash
vsce publish
```

发布前，确保 `package.json` 中的版本号已更新。

## 9. 最佳实践

### 9.1 性能优化

- **延迟激活**：使用合适的激活事件，避免在 VS Code 启动时激活插件
- **减少计算密集型操作**：将复杂计算放在后台线程中执行
- **使用 Webpack**：使用 Webpack 打包插件，减小插件体积
- **清理资源**：在 `deactivate` 函数中清理事件监听器、定时器等资源

### 9.2 代码质量

- **使用 TypeScript**：提供更好的类型检查和智能提示
- **遵循 ESLint 规则**：确保代码风格一致
- **编写测试**：为插件功能编写测试
- **使用 async/await**：避免回调地狱

### 9.3 用户体验

- **提供清晰的文档**：编写详细的 README.md
- **添加命令描述**：为命令添加清晰的标题和描述
- **使用合适的图标**：为命令和视图添加合适的图标
- **提供配置选项**：允许用户自定义插件行为
- **显示有用的通知**：使用通知向用户反馈操作结果

### 9.4 安全性

- **验证用户输入**：验证所有用户输入，避免注入攻击
- **使用 Webview 安全策略**：在 Webview 中使用 Content Security Policy
- **避免存储敏感信息**：不要在插件中存储敏感信息

## 10. 示例插件

### 10.1 完整示例

以下是一个完整的示例插件，实现了一个简单的 TODO 列表功能：

#### 10.1.1 package.json

```json
{
  "name": "todo-list",
  "displayName": "TODO List",
  "description": "A simple TODO list extension for VS Code",
  "version": "0.0.1",
  "engines": {
    "vscode": "^1.74.0"
  },
  "categories": [
    "Other"
  ],
  "activationEvents": [
    "onView:todoList"
  ],
  "main": "out/extension.js",
  "contributes": {
    "views": {
      "explorer": [
        {
          "id": "todoList",
          "name": "TODO List",
          "icon": "$(checklist)"
        }
      ]
    },
    "commands": [
      {
        "command": "todoList.addTodo",
        "title": "Add TODO",
        "icon": "$(plus)"
      },
      {
        "command": "todoList.toggleTodo",
        "title": "Toggle TODO"
      },
      {
        "command": "todoList.deleteTodo",
        "title": "Delete TODO",
        "icon": "$(trash)"
      }
    ],
    "menus": {
      "view/title": [
        {
          "command": "todoList.addTodo",
          "when": "view == todoList",
          "group": "navigation"
        }
      ],
      "view/item/context": [
        {
          "command": "todoList.toggleTodo",
          "when": "view == todoList"
        },
        {
          "command": "todoList.deleteTodo",
          "when": "view == todoList",
          "group": "inline"
        }
      ]
    }
  },
  "scripts": {
    "vscode:prepublish": "npm run compile",
    "compile": "tsc -p ./",
    "watch": "tsc -watch -p ./",
    "pretest": "npm run compile && npm run lint",
    "lint": "eslint src --ext ts",
    "test": "node ./out/test/runTest.js"
  },
  "devDependencies": {
    "@types/vscode": "^1.74.0",
    "@types/glob": "^8.0.0",
    "@types/mocha": "^10.0.0",
    "@types/node": "16.x",
    "@typescript-eslint/eslint-plugin": "^5.45.0",
    "@typescript-eslint/parser": "^5.45.0",
    "eslint": "^8.28.0",
    "glob": "^8.0.3",
    "mocha": "^10.1.0",
    "typescript": "^4.9.3",
    "@vscode/test-electron": "^2.2.0"
  }
}
```

#### 10.1.2 extension.ts

```typescript
import * as vscode from 'vscode';
import { TodoTreeDataProvider } from './todoTreeDataProvider';

export function activate(context: vscode.ExtensionContext) {
  const todoTreeDataProvider = new TodoTreeDataProvider(context);
  vscode.window.registerTreeDataProvider('todoList', todoTreeDataProvider);

  vscode.commands.registerCommand('todoList.addTodo', () => {
    todoTreeDataProvider.addTodo();
  });

  vscode.commands.registerCommand('todoList.toggleTodo', (item) => {
    todoTreeDataProvider.toggleTodo(item);
  });

  vscode.commands.registerCommand('todoList.deleteTodo', (item) => {
    todoTreeDataProvider.deleteTodo(item);
  });
}

export function deactivate() {}
```

#### 10.1.3 todoTreeDataProvider.ts

```typescript
import * as vscode from 'vscode';

interface TodoItem {
  id: string;
  text: string;
  completed: boolean;
}

class TodoTreeItem extends vscode.TreeItem {
  constructor(public readonly todo: TodoItem) {
    super(todo.text, vscode.TreeItemCollapsibleState.None);
    this.iconPath = new vscode.ThemeIcon(todo.completed ? 'check' : 'circle-outline');
    this.contextValue = 'todoItem';
  }
}

export class TodoTreeDataProvider implements vscode.TreeDataProvider<TodoTreeItem> {
  private _onDidChangeTreeData = new vscode.EventEmitter<TodoTreeItem | undefined>();
  readonly onDidChangeTreeData = this._onDidChangeTreeData.event;

  private todos: TodoItem[] = [];
  private readonly storageKey = 'todoList.todos';

  constructor(private context: vscode.ExtensionContext) {
    this.loadTodos();
  }

  private loadTodos() {
    const savedTodos = this.context.globalState.get<TodoItem[]>(this.storageKey);
    if (savedTodos) {
      this.todos = savedTodos;
    }
  }

  private saveTodos() {
    this.context.globalState.update(this.storageKey, this.todos);
    this.refresh();
  }

  getTreeItem(element: TodoTreeItem): vscode.TreeItem {
    return element;
  }

  getChildren(element?: TodoTreeItem): Thenable<TodoTreeItem[]> {
    return Promise.resolve(this.todos.map(todo => new TodoTreeItem(todo)));
  }

  refresh(): void {
    this._onDidChangeTreeData.fire(undefined);
  }

  async addTodo() {
    const text = await vscode.window.showInputBox({
      prompt: 'Enter TODO text',
      placeHolder: 'TODO text'
    });

    if (text && text.trim()) {
      const newTodo: TodoItem = {
        id: Date.now().toString(),
        text: text.trim(),
        completed: false
      };
      this.todos.push(newTodo);
      this.saveTodos();
    }
  }

  toggleTodo(item: TodoTreeItem) {
    const todo = this.todos.find(t => t.id === item.todo.id);
    if (todo) {
      todo.completed = !todo.completed;
      this.saveTodos();
    }
  }

  deleteTodo(item: TodoTreeItem) {
    this.todos = this.todos.filter(t => t.id !== item.todo.id);
    this.saveTodos();
  }
}
```

## 11. 进阶主题

### 11.1 Web 扩展

Web 扩展可以在 VS Code Web 中运行，使用 Webpack 打包，并且只能使用特定的 API。创建 Web 扩展时，选择 `New Web Extension` 模板。

### 11.2 Remote 扩展

Remote 扩展可以在远程环境中运行，如 WSL、SSH 和容器。Remote 扩展需要注意以下几点：

- 扩展可以在本地或远程运行，取决于扩展的配置
- 使用 `extensionKind` 字段指定扩展运行位置：`ui`（本地）、`workspace`（远程）或 `both`（两者）
- 注意文件路径和 URI 的处理

### 11.3 语言服务器扩展

语言服务器扩展用于提供语言支持，如语法高亮、智能提示、代码导航等。创建语言服务器扩展时，选择 `New Language Support` 模板。

### 11.4 主题扩展

主题扩展用于自定义 VS Code 的颜色和图标。创建主题扩展时，选择 `New Theme`、`New Color Theme` 或 `New Icon Theme` 模板。

## 12. 资源和学习资料

### 12.1 官方文档

- **VS Code 扩展 API 文档**：https://code.visualstudio.com/api
- **VS Code 扩展示例**：https://github.com/microsoft/vscode-extension-samples
- **Yeoman 生成器**：https://github.com/microsoft/vscode-generator-code

### 12.2 学习资源

- **VS Code 扩展开发教程**：https://code.visualstudio.com/api/get-started/your-first-extension
- **VS Code 扩展 API 视频教程**：https://code.visualstudio.com/api/get-started/vscode-api
- **VS Code 扩展开发博客**：https://code.visualstudio.com/blogs/2015/07/20/extension-api

### 12.3 社区资源

- **VS Code 扩展市场**：https://marketplace.visualstudio.com/vscode
- **VS Code 扩展开发社区**：https://github.com/microsoft/vscode/issues
- **Stack Overflow**：https://stackoverflow.com/questions/tagged/visual-studio-code

## 13. 总结

VS Code 插件开发是扩展 VS Code 功能的强大方式。通过学习 VS Code 插件开发，您可以创建自定义功能，提高开发效率，甚至发布插件到 VS Code 市场，与全球开发者分享您的创意。

在开发插件时，建议：
1. 从小功能开始，逐步扩展
2. 学习官方文档和示例
3. 遵循最佳实践
4. 测试您的插件
5. 收集用户反馈
6. 持续改进

通过不断学习和实践，您将能够开发出高质量的 VS Code 插件，为 VS Code 生态系统做出贡献。