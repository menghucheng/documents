# Poetry 环境管理文档

## 1. 基础概念

### 1.1 什么是 Poetry？

Poetry 是一个现代化的 Python 依赖管理和打包工具，它提供了依赖解析、虚拟环境管理、项目打包和发布等功能。Poetry 使用 `pyproject.toml` 文件来管理项目配置和依赖，替代了传统的 `setup.py` 和 `requirements.txt` 文件。

### 1.2 核心特性

- **依赖解析**：自动处理复杂的依赖关系，避免版本冲突
- **虚拟环境管理**：自动创建和管理虚拟环境
- **依赖锁定**：使用 `poetry.lock` 文件锁定依赖版本，确保一致性
- **项目打包**：支持将项目打包为可分发的包
- **发布支持**：直接发布到 PyPI
- **开发和生产依赖分离**：清晰区分开发依赖和生产依赖
- **跨平台**：支持 Windows、macOS 和 Linux 系统
- **TypeScript 风格的依赖声明**：使用简单的语法声明依赖

### 1.3 与其他环境管理工具的比较

| 特性 | Poetry | venv | conda | pipenv |
|------|--------|------|-------|--------|
| 自动虚拟环境管理 | 是 | 否 | 否 | 是 |
| 依赖锁定 | 是 | 否 | 是 | 是 |
| 开发/生产依赖分离 | 是 | 否 | 是 | 是 |
| 项目打包支持 | 是 | 否 | 否 | 否 |
| PyPI 发布支持 | 是 | 否 | 否 | 否 |
| 跨语言支持 | 否 | 否 | 是 | 否 |
| 配置复杂度 | 中等 | 简单 | 中等 | 中等 |
| 资源占用 | 中等 | 低 | 高 | 中等 |

## 2. 安装

### 2.1 使用官方安装脚本

推荐使用官方安装脚本安装 Poetry：

```bash
# Windows
(Invoke-WebRequest -Uri https://install.python-poetry.org -UseBasicParsing).Content | python -n

# macOS/Linux
curl -sSL https://install.python-poetry.org | python3 -n
```

### 2.2 使用 pip 安装

也可以使用 pip 安装 Poetry：

```bash
# Windows
pip install poetry

# macOS/Linux
pip3 install poetry
```

### 2.3 验证安装

```bash
poetry --version
```

### 2.4 配置环境变量

确保 Poetry 的可执行文件路径已添加到系统环境变量中。安装后，Poetry 会提示如何配置环境变量。

## 3. 基本使用

### 3.1 创建新项目

使用 `poetry new` 命令创建新项目：

```bash
poetry new myproject
```

这将创建以下项目结构：

```
myproject/
├── myproject/               # 项目模块
│   └── __init__.py        # 模块初始化文件
├── tests/                 # 测试目录
│   └── __init__.py        # 测试初始化文件
├── pyproject.toml         # Poetry 配置文件
├── README.md              # 项目说明文档
└── .gitignore             # Git 忽略文件
```

### 3.2 初始化现有项目

在现有项目目录中初始化 Poetry：

```bash
cd existing-project
poetry init
```

这将交互式地创建 `pyproject.toml` 文件。

### 3.3 安装依赖

#### 3.3.1 安装生产依赖

```bash
poetry add <package>
```

#### 3.3.2 安装开发依赖

```bash
poetry add --dev <package>
```

#### 3.3.3 安装特定版本的依赖

```bash
poetry add <package>@<version>
```

例如：

```bash
poetry add requests@^2.31.0
```

### 3.4 激活虚拟环境

```bash
poetry shell
```

激活后，终端提示符会显示虚拟环境名称。

### 3.5 在虚拟环境中运行命令

不激活虚拟环境，直接在虚拟环境中运行命令：

```bash
poetry run <command>
```

例如：

```bash
poetry run python script.py
poetry run pytest
```

### 3.6 退出虚拟环境

```bash
exit
```

## 4. 依赖管理

### 4.1 查看已安装的依赖

```bash
poetry show
```

查看详细的依赖信息：

```bash
poetry show <package>
```

查看依赖树：

```bash
poetry show --tree
```

### 4.2 更新依赖

#### 4.2.1 更新单个依赖

```bash
poetry update <package>
```

#### 4.2.2 更新所有依赖

```bash
poetry update
```

#### 4.2.3 检查过时的依赖

```bash
poetry show --outdated
```

### 4.3 卸载依赖

#### 4.3.1 卸载生产依赖

```bash
poetry remove <package>
```

#### 4.3.2 卸载开发依赖

```bash
poetry remove --dev <package>
```

### 4.4 安装所有依赖

从 `poetry.lock` 文件安装所有依赖：

```bash
poetry install
```

仅安装生产依赖：

```bash
poetry install --no-dev
```

## 5. pyproject.toml 和 poetry.lock

### 5.1 pyproject.toml 结构

`pyproject.toml` 是 Poetry 项目的核心配置文件，包含项目信息、依赖和构建配置：

```toml
# pyproject.toml
[tool.poetry]
name = "myproject"
version = "0.1.0"
description = "A sample Python project"
authors = ["Your Name <your.email@example.com>"]
readme = "README.md"
packages = [{ include = "myproject" }]

[tool.poetry.dependencies]
python = "^3.10"
requests = "^2.31.0"
pandas = "^2.0.3"

[tool.poetry.group.dev.dependencies]
pytest = "^7.3.1"
black = "^23.3.0"
flake8 = "^6.0.0"

[build-system]
requires = ["poetry-core>=1.0.0"]
build-backend = "poetry.core.masonry.api"
```

### 5.2 poetry.lock 结构

`poetry.lock` 是自动生成的锁定文件，包含所有依赖的精确版本和哈希值：

```toml
# poetry.lock
# This file is automatically generated by Poetry and should not be changed by hand.
[[package]]
name = "requests"
version = "2.31.0"
description = "Python HTTP for Humans."
category = "main"
optional = false
python-versions = ">=3.7"
files = [
    {file = "requests-2.31.0-py3-none-any.whl", hash = "sha256:..."},
    {file = "requests-2.31.0.tar.gz", hash = "sha256:..."},
]

[package.dependencies]
certifi = ">=2017.4.17"
charset-normalizer = ">=2,<4"
idna = ">=2.5,<4"
urllib3 = ">=1.21.1,<3"

# ... 其他依赖 ...

[metadata]
lock-version = "2.0"
python-versions = "^3.10"
content-hash = "..."
```

## 6. 脚本

### 6.1 在 pyproject.toml 中定义脚本

可以在 `pyproject.toml` 的 `[tool.poetry.scripts]` 部分定义常用脚本：

```toml
# pyproject.toml
[tool.poetry.scripts]
my-script = "myproject.main:main"
test = "pytest"
```

### 6.2 运行脚本

使用 `poetry run <script-name>` 命令运行脚本：

```bash
poetry run my-script
poetry run test
```

## 7. 项目打包和发布

### 7.1 构建项目

将项目打包为可分发的包：

```bash
poetry build
```

这将在 `dist` 目录中生成 `.tar.gz` 和 `.whl` 文件。

### 7.2 发布到 PyPI

首先，配置 PyPI 凭据：

```bash
poetry config pypi-token.pypi <your-pypi-token>
```

然后发布项目：

```bash
poetry publish
```

### 7.3 发布到测试 PyPI

```bash
poetry publish -r testpypi
```

## 8. 高级用法

### 8.1 指定 Python 版本

在 `pyproject.toml` 中指定 Python 版本范围：

```toml
# pyproject.toml
[tool.poetry.dependencies]
python = "^3.10"
```

### 8.2 导出 requirements.txt

将 Poetry 依赖导出到 `requirements.txt` 文件：

```bash
# 导出生产依赖
poetry export --output requirements.txt

# 导出开发依赖
poetry export --with dev --output dev-requirements.txt
```

### 8.3 从 requirements.txt 导入

Poetry 不直接支持从 `requirements.txt` 导入依赖，但可以使用以下方法：

1. 手动将依赖添加到 `pyproject.toml`
2. 使用第三方工具，如 `poetry-requirements-plugin`

### 8.4 配置虚拟环境位置

默认情况下，Poetry 将虚拟环境创建在 `~/.cache/pypoetry/virtualenvs/` 目录中。可以配置为在项目目录中创建：

```bash
poetry config virtualenvs.in-project true
```

### 8.5 清理未使用的依赖

清理未使用的依赖：

```bash
poetry remove --unused
```

## 9. 与 IDE 集成

### 9.1 VS Code 集成

1. 安装 Python 扩展
2. 打开项目文件夹
3. 在 VS Code 底部状态栏点击 Python 解释器版本
4. 选择 "Python: Select Interpreter"
5. 选择 Poetry 环境中的 Python 解释器：
   - Windows：`C:\Users\Username\.cache\pypoetry\virtualenvs\myproject-xxxxxx\Scripts\python.exe`
   - macOS/Linux：`/Users/username/.cache/pypoetry/virtualenvs/myproject-xxxxxx/bin/python`

### 9.2 PyCharm 集成

1. 打开项目
2. 点击 "File" > "Settings" > "Project: <project_name>" > "Python Interpreter"
3. 点击齿轮图标，选择 "Add..."
4. 选择 "Poetry Environment"
5. 点击 "OK" 完成配置

## 10. 最佳实践

### 10.1 项目结构

推荐的项目结构：

```
myproject/
├── myproject/               # 项目模块
│   ├── __init__.py        # 模块初始化文件
│   ├── main.py            # 主程序文件
│   └── utils.py           # 工具函数
├── tests/                 # 测试目录
│   ├── __init__.py        # 测试初始化文件
│   └── test_main.py       # 测试文件
├── docs/                  # 文档目录
├── pyproject.toml         # Poetry 配置文件
├── poetry.lock            # 依赖锁定文件
├── README.md              # 项目说明文档
└── .gitignore             # Git 忽略文件
```

### 10.2 忽略不必要的文件

在 `.gitignore` 文件中添加以下内容：

```
# .gitignore
__pycache__/
*.pyc
*.pyo
*.pyd
.venv/
.env
.env.local
.env.*.local
dist/
build/
*.egg-info/
.pytest_cache/
.coverage
htmlcov/
.vscode/
.idea/
*.swp
*.swo
*~
```

### 10.3 使用精确的依赖版本

在 `pyproject.toml` 中使用精确的依赖版本范围，确保项目在不同环境中运行一致：

```toml
# pyproject.toml
[tool.poetry.dependencies]
requests = "^2.31.0"
pandas = "^2.0.3"
matplotlib = "^3.7.2"
```

### 10.4 定期更新依赖

定期更新依赖以获取安全修复和新功能：

```bash
poetry update
```

### 10.5 提交 poetry.lock

将 `poetry.lock` 提交到版本控制，确保所有开发者使用相同的依赖版本：

```bash
git add pyproject.toml poetry.lock
git commit -m "Update dependencies"
```

### 10.6 分离开发和生产依赖

将依赖明确分为开发依赖和生产依赖：

```toml
# pyproject.toml
[tool.poetry.dependencies]
# 生产依赖
requests = "^2.31.0"
pandas = "^2.0.3"

[tool.poetry.group.dev.dependencies]
# 开发依赖
pytest = "^7.3.1"
black = "^23.3.0"
flake8 = "^6.0.0"
```

## 11. 常见问题

### 11.1 虚拟环境激活失败

如果遇到虚拟环境激活失败问题，可以尝试以下解决方案：

- 检查 Poetry 是否已正确安装
- 尝试重新创建虚拟环境：`poetry env remove python && poetry install`
- 检查 Python 版本是否可用：`python --version`
- 查看 Poetry 日志：`poetry --verbose shell`

### 11.2 依赖安装失败

如果遇到依赖安装失败问题，可以尝试以下解决方案：

- 检查网络连接
- 尝试更新 Poetry：`poetry self update`
- 清理 Poetry 缓存：`poetry cache clear --all pypi`
- 检查依赖版本是否兼容
- 尝试使用 `--no-root` 参数：`poetry install --no-root`

### 11.3 poetry.lock 冲突

如果遇到 `poetry.lock` 冲突问题，可以尝试以下解决方案：

- 合并 `pyproject.toml` 文件
- 重新生成 `poetry.lock`：`poetry lock --no-update`
- 清理并重新安装：`poetry env remove python && poetry install`

### 11.4 配置虚拟环境位置

如果想在项目目录中创建虚拟环境，可以使用以下命令：

```bash
poetry config virtualenvs.in-project true
```

## 12. 资源

- **官方文档**：https://python-poetry.org/docs/
- **GitHub 仓库**：https://github.com/python-poetry/poetry
- **PyPI 页面**：https://pypi.org/project/poetry/
- **Poetry 教程**：https://realpython.com/dependency-management-python-poetry/

## 13. 总结

Poetry 是一个现代化的 Python 依赖管理和打包工具，它提供了依赖解析、虚拟环境管理、项目打包和发布等功能。Poetry 使用 `pyproject.toml` 和 `poetry.lock` 文件来管理项目配置和依赖，替代了传统的 `setup.py` 和 `requirements.txt` 文件。

Poetry 的核心优势在于：

1. **强大的依赖解析**：自动处理复杂的依赖关系，避免版本冲突
2. **自动虚拟环境管理**：无需手动创建和管理虚拟环境
3. **依赖锁定**：使用 `poetry.lock` 确保依赖版本一致性
4. **项目打包和发布支持**：直接打包和发布到 PyPI
5. **开发和生产依赖分离**：清晰区分不同环境的依赖
6. **跨平台**：在 Windows、macOS 和 Linux 上表现一致

通过学习和使用 Poetry，开发者可以更高效地管理 Python 项目依赖，提高开发效率，确保项目在不同环境中运行一致。无论是小型项目还是大型应用，Poetry 都能提供可靠的依赖管理和打包解决方案。