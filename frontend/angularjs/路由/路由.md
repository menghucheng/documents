# AngularJS 路由

## 1. 概述

AngularJS 路由允许将应用程序划分为多个视图，并根据 URL 路径加载不同的视图。通过路由，可以实现单页应用（SPA）的核心功能，即无需刷新页面即可切换不同的内容视图。

路由的主要作用：
- 将应用程序划分为多个逻辑视图
- 根据 URL 路径加载对应的控制器和模板
- 支持参数传递和嵌套路由
- 实现页面间的导航

## 2. 路由模块安装

AngularJS 1.2+ 版本将路由功能从核心模块中分离出来，需要单独引入 `ngRoute` 模块。

### 2.1 引入依赖

```html
<!-- 引入 AngularJS 核心库 -->
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
<!-- 引入 AngularJS 路由模块 -->
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular-route.min.js"></script>
```

### 2.2 注入路由模块

```javascript
// 在应用中注入 ngRoute 模块
var app = angular.module('myApp', ['ngRoute']);
```

## 3. 基本路由配置

### 3.1 路由配置语法

使用 `$routeProvider` 服务配置路由规则：

```javascript
app.config(function($routeProvider) {
    $routeProvider
        .when('/home', {
            templateUrl: 'views/home.html',
            controller: 'HomeController'
        })
        .when('/about', {
            templateUrl: 'views/about.html',
            controller: 'AboutController'
        })
        .otherwise({
            redirectTo: '/home'
        });
});
```

### 3.2 路由配置参数

| 参数 | 描述 |
|------|------|
| `templateUrl` | 视图模板文件路径 |
| `template` | 内联 HTML 模板 |
| `controller` | 控制器名称或函数 |
| `controllerAs` | 控制器别名（推荐使用） |
| `redirectTo` | 重定向 URL |
| `resolve` | 路由解析，加载数据后再渲染视图 |

### 3.3 路由视图容器

在 HTML 中使用 `ng-view` 指令作为路由视图的容器：

```html
<!DOCTYPE html>
<html ng-app="myApp">
<head>
    <title>AngularJS 路由示例</title>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular-route.min.js"></script>
</head>
<body>
    <h1>AngularJS 路由示例</h1>
    
    <!-- 导航链接 -->
    <nav>
        <a href="#/home">首页</a> | 
        <a href="#/about">关于我们</a> | 
        <a href="#/contact">联系我们</a>
    </nav>
    
    <!-- 路由视图容器 -->
    <div ng-view></div>
    
    <script>
        // 创建应用
        var app = angular.module('myApp', ['ngRoute']);
        
        // 配置路由
        app.config(function($routeProvider) {
            $routeProvider
                .when('/home', {
                    template: '<h2>首页</h2><p>欢迎来到我们的网站！</p>',
                    controller: function($scope) {
                        $scope.message = '这是首页内容';
                    }
                })
                .when('/about', {
                    template: '<h2>关于我们</h2><p>{{ message }}</p>',
                    controller: function($scope) {
                        $scope.message = '这是关于我们的内容';
                    }
                })
                .when('/contact', {
                    template: '<h2>联系我们</h2><p>联系方式：contact@example.com</p>',
                    controller: 'ContactController'
                })
                .otherwise({
                    redirectTo: '/home'
                });
        });
        
        // 定义控制器
        app.controller('ContactController', function($scope) {
            $scope.message = '这是联系我们页面';
        });
    </script>
</body>
</html>
```

## 4. 路由参数

### 4.1 基本参数传递

在路由配置中使用 `:` 定义参数，通过 `$routeParams` 服务获取参数值：

```javascript
app.config(function($routeProvider) {
    $routeProvider
        .when('/user/:id', {
            templateUrl: 'views/user.html',
            controller: 'UserController'
        });
});

app.controller('UserController', function($scope, $routeParams) {
    // 获取路由参数
    var userId = $routeParams.id;
    $scope.userId = userId;
});
```

### 4.2 多参数传递

```javascript
app.config(function($routeProvider) {
    $routeProvider
        .when('/product/:category/:id', {
            templateUrl: 'views/product.html',
            controller: 'ProductController'
        });
});

app.controller('ProductController', function($scope, $routeParams) {
    $scope.category = $routeParams.category;
    $scope.productId = $routeParams.id;
});
```

### 4.3 可选参数

通过查询字符串传递可选参数：

```html
<!-- 链接 -->
<a href="#/search?keyword=angular&category=js">搜索</a>

<!-- 控制器中获取 -->
app.controller('SearchController', function($scope, $location) {
    // 使用 $location.search() 获取查询参数
    var searchParams = $location.search();
    $scope.keyword = searchParams.keyword;
    $scope.category = searchParams.category;
});
```

## 5. 路由控制器与作用域

### 5.1 使用 controllerAs 语法

推荐使用 `controllerAs` 语法，避免作用域嵌套问题：

```javascript
app.config(function($routeProvider) {
    $routeProvider
        .when('/home', {
            templateUrl: 'views/home.html',
            controller: 'HomeController',
            controllerAs: 'vm'
        });
});

app.controller('HomeController', function() {
    var vm = this;
    vm.message = '使用 controllerAs 语法';
    vm.greet = function() {
        return 'Hello, ' + vm.name;
    };
});
```

模板中使用：

```html
<h2>首页</h2>
<p>{{ vm.message }}</p>
<input type="text" ng-model="vm.name">
<p>{{ vm.greet() }}</p>
```

## 6. 路由解析（Resolve）

使用 `resolve` 可以在路由加载前预加载数据，确保视图渲染时数据已经准备就绪：

### 6.1 基本使用

```javascript
app.config(function($routeProvider) {
    $routeProvider
        .when('/user/:id', {
            templateUrl: 'views/user.html',
            controller: 'UserController',
            resolve: {
                userData: function($http, $routeParams) {
                    return $http.get('https://jsonplaceholder.typicode.com/users/' + $routeParams.id)
                        .then(function(response) {
                            return response.data;
                        });
                }
            }
        });
});

app.controller('UserController', function($scope, userData) {
    // userData 是 resolve 中返回的数据
    $scope.user = userData;
});
```

### 6.2 使用服务

```javascript
// 定义服务
app.service('UserService', function($http) {
    this.getUser = function(userId) {
        return $http.get('https://jsonplaceholder.typicode.com/users/' + userId)
            .then(function(response) {
                return response.data;
            });
    };
});

// 路由配置中使用服务
app.config(function($routeProvider) {
    $routeProvider
        .when('/user/:id', {
            templateUrl: 'views/user.html',
            controller: 'UserController',
            resolve: {
                userData: function(UserService, $routeParams) {
                    return UserService.getUser($routeParams.id);
                }
            }
        });
});
```

## 7. 嵌套路由

AngularJS 的 `ngRoute` 模块本身不直接支持嵌套路由，但可以通过一些技巧实现：

### 7.1 基本嵌套路由

```javascript
app.config(function($routeProvider) {
    $routeProvider
        .when('/admin', {
            templateUrl: 'views/admin.html',
            controller: 'AdminController'
        })
        .when('/admin/users', {
            templateUrl: 'views/admin-users.html',
            controller: 'AdminUsersController'
        })
        .when('/admin/products', {
            templateUrl: 'views/admin-products.html',
            controller: 'AdminProductsController'
        });
});
```

admin.html 模板：

```html
<h2>管理后台</h2>
<nav>
    <a href="#/admin/users">用户管理</a> | 
    <a href="#/admin/products">产品管理</a>
</nav>
<div ng-view></div>
```

## 8. 路由导航

### 8.1 使用 $location 服务

在控制器中使用 `$location` 服务进行编程式导航：

```javascript
app.controller('HomeController', function($scope, $location) {
    $scope.goToAbout = function() {
        // 导航到 /about 路由
        $location.path('/about');
    };
    
    $scope.goToUser = function(userId) {
        // 导航到带参数的路由
        $location.path('/user/' + userId);
    };
    
    $scope.search = function(keyword) {
        // 导航到带查询参数的路由
        $location.path('/search').search({keyword: keyword});
    };
});
```

### 8.2 使用 $route 服务

```javascript
app.controller('HomeController', function($scope, $route) {
    // 重新加载当前路由
    $scope.reload = function() {
        $route.reload();
    };
});
```

## 9. 路由事件

AngularJS 提供了路由相关的事件，可以在路由变化时执行相应的逻辑：

### 9.1 常用路由事件

| 事件 | 描述 |
|------|------|
| `$routeChangeStart` | 路由变化开始前触发 |
| `$routeChangeSuccess` | 路由变化成功后触发 |
| `$routeChangeError` | 路由变化出错时触发 |
| `$routeUpdate` | 路由更新时触发（当 reloadOnSearch 为 false 时） |

### 9.2 事件监听示例

```javascript
app.controller('MainController', function($scope, $rootScope) {
    // 监听路由变化开始事件
    $rootScope.$on('$routeChangeStart', function(event, next, current) {
        console.log('路由变化开始');
        console.log('下一个路由:', next);
        console.log('当前路由:', current);
        
        // 可以在这里进行权限验证
        // if (!isAuthenticated && next.requiresAuth) {
        //     event.preventDefault();
        //     $location.path('/login');
        // }
    });
    
    // 监听路由变化成功事件
    $rootScope.$on('$routeChangeSuccess', function(event, current, previous) {
        console.log('路由变化成功');
        console.log('当前路由:', current);
        console.log('上一个路由:', previous);
    });
    
    // 监听路由变化错误事件
    $rootScope.$on('$routeChangeError', function(event, current, previous, rejection) {
        console.error('路由变化出错:', rejection);
    });
});
```

## 10. 路由配置选项

### 10.1 reloadOnSearch

当 URL 查询参数变化时，是否重新加载路由（默认：true）：

```javascript
app.config(function($routeProvider) {
    $routeProvider
        .when('/search', {
            templateUrl: 'views/search.html',
            controller: 'SearchController',
            reloadOnSearch: false
        });
});
```

### 10.2 caseInsensitiveMatch

是否忽略 URL 路径的大小写（默认：false）：

```javascript
app.config(function($routeProvider) {
    $routeProvider
        .when('/about', {
            templateUrl: 'views/about.html',
            controller: 'AboutController',
            caseInsensitiveMatch: true
        });
});
```

## 11. 完整示例

### 11.1 项目结构

```
angularjs-routing-demo/
├── index.html
├── app.js
└── views/
    ├── home.html
    ├── about.html
    ├── contact.html
    └── user.html
```

### 11.2 代码实现

index.html：

```html
<!DOCTYPE html>
<html ng-app="myApp">
<head>
    <title>AngularJS 路由完整示例</title>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular-route.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        nav {
            background-color: #f0f0f0;
            padding: 10px;
            margin-bottom: 20px;
        }
        nav a {
            margin: 0 10px;
            text-decoration: none;
            color: #333;
        }
        nav a.active {
            color: #007bff;
            font-weight: bold;
        }
        .view-container {
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body ng-controller="MainController">
    <h1>AngularJS 路由示例</h1>
    
    <nav>
        <a href="#/home" ng-class="{active: isActive('/home')}">首页</a> | 
        <a href="#/about" ng-class="{active: isActive('/about')}">关于我们</a> | 
        <a href="#/contact" ng-class="{active: isActive('/contact')}">联系我们</a> | 
        <a href="#/user/1" ng-class="{active: isActive('/user')}">用户详情</a>
    </nav>
    
    <div class="view-container" ng-view></div>
    
    <script src="app.js"></script>
</body>
</html>
```

app.js：

```javascript
// 创建应用
var app = angular.module('myApp', ['ngRoute']);

// 主控制器
app.controller('MainController', function($scope, $location, $rootScope) {
    $scope.isActive = function(path) {
        return $location.path().indexOf(path) === 0;
    };
    
    // 监听路由变化
    $rootScope.$on('$routeChangeSuccess', function(event, current) {
        $rootScope.currentRoute = current.$$route.originalPath;
    });
});

// 配置路由
app.config(function($routeProvider) {
    $routeProvider
        .when('/home', {
            templateUrl: 'views/home.html',
            controller: 'HomeController',
            controllerAs: 'vm'
        })
        .when('/about', {
            templateUrl: 'views/about.html',
            controller: 'AboutController',
            controllerAs: 'vm'
        })
        .when('/contact', {
            templateUrl: 'views/contact.html',
            controller: 'ContactController',
            controllerAs: 'vm'
        })
        .when('/user/:id', {
            templateUrl: 'views/user.html',
            controller: 'UserController',
            controllerAs: 'vm',
            resolve: {
                userData: function($http, $routeParams) {
                    return $http.get('https://jsonplaceholder.typicode.com/users/' + $routeParams.id)
                        .then(function(response) {
                            return response.data;
                        });
                }
            }
        })
        .otherwise({
            redirectTo: '/home'
        });
});

// 首页控制器
app.controller('HomeController', function() {
    var vm = this;
    vm.title = '欢迎来到首页';
    vm.message = '这是一个 AngularJS 路由示例应用';
});

// 关于我们控制器
app.controller('AboutController', function() {
    var vm = this;
    vm.title = '关于我们';
    vm.content = '我们是一家专注于 AngularJS 开发的公司';
});

// 联系我们控制器
app.controller('ContactController', function() {
    var vm = this;
    vm.title = '联系我们';
    vm.email = 'contact@example.com';
    vm.phone = '123-456-7890';
});

// 用户详情控制器
app.controller('UserController', function(userData) {
    var vm = this;
    vm.user = userData;
});
```

views/home.html：

```html
<h2>{{ vm.title }}</h2>
<p>{{ vm.message }}</p>
<button ng-click="vm.goToAbout()">前往关于我们</button>
```

views/about.html：

```html
<h2>{{ vm.title }}</h2>
<p>{{ vm.content }}</p>
```

views/contact.html：

```html
<h2>{{ vm.title }}</h2>
<p>邮箱：{{ vm.email }}</p>
<p>电话：{{ vm.phone }}</p>
```

views/user.html：

```html
<h2>用户详情</h2>
<div ng-if="vm.user">
    <h3>{{ vm.user.name }}</h3>
    <p>邮箱：{{ vm.user.email }}</p>
    <p>电话：{{ vm.user.phone }}</p>
    <p>网站：{{ vm.user.website }}</p>
    <p>公司：{{ vm.user.company.name }}</p>
</div>
<button ng-click="vm.goBack()">返回</button>
```

## 12. 路由的优缺点

### 12.1 优点

- 实现单页应用，提升用户体验
- 清晰的 URL 结构，便于书签和分享
- 模块化的应用架构
- 支持参数传递和嵌套路由
- 丰富的事件机制

### 12.2 缺点

- ngRoute 模块功能相对简单，不支持复杂的嵌套路由
- 对于大型应用，路由配置可能变得复杂
- 不支持路由守卫（需要手动实现）
- 与现代前端框架的路由相比，功能有限

## 13. 替代方案

对于复杂应用，可以考虑使用第三方路由库：

- **UI-Router**：功能更强大，支持嵌套路由、命名视图等
- **AngularUI Router**：基于 UI-Router 的 AngularJS 集成

## 14. 总结

AngularJS 路由是构建单页应用的核心功能之一，通过路由可以将应用程序划分为多个视图，并根据 URL 路径加载不同的内容。本文介绍了 AngularJS 路由的基本概念、配置方法、参数传递、路由解析、导航方式等内容。

主要内容包括：

1. 路由的基本概念和作用
2. 路由模块的安装和配置
3. 路由参数的传递和获取
4. 路由控制器与作用域管理
5. 路由解析（Resolve）的使用
6. 路由导航方式
7. 路由事件的监听和处理
8. 完整的路由示例

通过掌握 AngularJS 路由的使用，可以构建出功能完整、用户体验良好的单页应用。虽然 AngularJS 已经是一个比较旧的框架，但它的路由机制仍然具有学习价值，特别是对于理解前端路由的基本概念和原理非常有帮助。