# Next.js 部署

## 1. 部署概述

Next.js 应用可以部署到多种平台，包括 Vercel、Netlify、AWS、Google Cloud 等。部署方式取决于应用的需求、预算和团队偏好。

## 2. 构建应用

在部署之前，需要先构建 Next.js 应用：

```bash
# 安装依赖
npm install

# 构建应用
npm run build

# 启动生产服务器（可选，用于本地测试）
npm start
```

构建完成后，生成的静态文件和服务器代码存放在 `.next/` 目录中。

## 3. 部署到 Vercel

Vercel 是 Next.js 的官方托管平台，提供最佳的 Next.js 支持和性能优化。

### 3.1 部署步骤

1. **创建 Vercel 账号**
   - 访问 [Vercel](https://vercel.com/) 并注册账号

2. **连接 GitHub/GitLab/Bitbucket 仓库**
   - 在 Vercel 仪表板中，点击 "New Project"
   - 选择要部署的仓库

3. **配置部署选项**
   - 选择框架：Next.js（自动检测）
   - 配置构建命令：`npm run build`
   - 配置输出目录：`.next`
   - 配置环境变量

4. **部署应用**
   - 点击 "Deploy" 按钮
   - 等待部署完成
   - 获得部署 URL（如 `https://your-app.vercel.app`）

### 3.2 自动部署

- 每次推送到主分支时，Vercel 会自动部署应用
- 支持预览分支部署，每个 PR 会生成预览 URL

### 3.3 环境变量配置

在 Vercel 仪表板中，可以配置环境变量：

1. 进入项目设置
2. 选择 "Environment Variables"
3. 添加所需的环境变量
4. 点击 "Save"

## 4. 部署到 Netlify

Netlify 是另一个流行的静态站点托管平台，支持 Next.js 应用部署。

### 4.1 部署步骤

1. **创建 Netlify 账号**
   - 访问 [Netlify](https://www.netlify.com/) 并注册账号

2. **连接 GitHub/GitLab/Bitbucket 仓库**
   - 在 Netlify 仪表板中，点击 "New site from Git"
   - 选择要部署的仓库

3. **配置部署选项**
   - 选择分支：`main` 或 `master`
   - 配置构建命令：`npm run build`
   - 配置发布目录：`.next/out`（需要在 `next.config.js` 中配置 `distDir: 'out'`）
   - 配置环境变量

4. **部署应用**
   - 点击 "Deploy site"
   - 等待部署完成
   - 获得部署 URL（如 `https://your-app.netlify.app`）

### 4.2 Netlify 配置文件

可以在项目根目录创建 `netlify.toml` 文件，配置部署选项：

```toml
# netlify.toml
[build]
  command = "npm run build"
  publish = ".next/out"

[build.environment]
  NODE_VERSION = "16"

[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200
```

## 5. 部署到 AWS

AWS 提供多种服务来部署 Next.js 应用，包括 EC2、S3 + CloudFront、Lambda 等。

### 5.1 使用 EC2 部署

1. **创建 EC2 实例**
   - 选择 Ubuntu 或 Amazon Linux 镜像
   - 配置安全组，开放 80 和 3000 端口

2. **连接到 EC2 实例**
   ```bash
   ssh -i your-key.pem ec2-user@your-ec2-ip
   ```

3. **安装 Node.js 和 npm**
   ```bash
   # Ubuntu
   curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash -
   sudo apt-get install -y nodejs

   # Amazon Linux
   sudo yum update -y
   sudo yum install -y nodejs
   ```

4. **克隆代码并构建应用**
   ```bash
   git clone https://github.com/your-username/your-app.git
   cd your-app
   npm install
   npm run build
   ```

5. **启动应用**
   ```bash
   # 使用 PM2 管理进程
   npm install -g pm2
   pm2 start npm --name "next-app" -- start
   pm2 startup
   pm2 save
   ```

6. **配置 Nginx 反向代理**
   ```bash
   sudo apt-get install -y nginx
   sudo nano /etc/nginx/sites-available/next-app
   ```

   添加以下配置：
   ```nginx
   server {
       listen 80;
       server_name your-domain.com;

       location / {
           proxy_pass http://localhost:3000;
           proxy_http_version 1.1;
           proxy_set_header Upgrade $http_upgrade;
           proxy_set_header Connection 'upgrade';
           proxy_set_header Host $host;
           proxy_cache_bypass $http_upgrade;
       }
   }
   ```

   启用配置并重启 Nginx：
   ```bash
   sudo ln -s /etc/nginx/sites-available/next-app /etc/nginx/sites-enabled/
   sudo nginx -t
   sudo systemctl restart nginx
   ```

### 5.2 使用 S3 + CloudFront 部署静态导出应用

1. **配置 Next.js 静态导出**
   - 在 `next.config.js` 中添加配置：
     ```js
     // next.config.js
     module.exports = {
       output: 'export',
     };
     ```

2. **构建静态应用**
   ```bash
   npm run build
   ```
   构建完成后，生成的静态文件存放在 `out/` 目录中。

3. **上传到 S3 存储桶**
   - 创建 S3 存储桶，禁用阻止公共访问
   - 上传 `out/` 目录中的所有文件到 S3 存储桶
   - 配置存储桶属性，启用静态网站托管

4. **配置 CloudFront 分发**
   - 创建 CloudFront 分发
   - 设置原点为 S3 存储桶的静态网站托管 URL
   - 配置缓存行为和 SSL 证书
   - 等待分发部署完成

## 6. 部署到 Google Cloud

### 6.1 使用 Cloud Run 部署

1. **安装 gcloud CLI**
   - 访问 [Google Cloud SDK](https://cloud.google.com/sdk/docs/install) 安装 gcloud CLI
   - 初始化 gcloud：`gcloud init`

2. **创建 Dockerfile**
   ```dockerfile
   # Dockerfile
   FROM node:16-alpine

   WORKDIR /app

   COPY package*.json ./
   RUN npm install

   COPY . .
   RUN npm run build

   EXPOSE 3000
   CMD ["npm", "start"]
   ```

3. **构建并推送 Docker 镜像**
   ```bash
   gcloud builds submit --tag gcr.io/your-project-id/next-app
   ```

4. **部署到 Cloud Run**
   ```bash
   gcloud run deploy next-app --image gcr.io/your-project-id/next-app --platform managed --region us-central1 --allow-unauthenticated
   ```

## 7. 自定义服务器部署

如果使用自定义服务器，可以部署到各种 VPS 或云服务提供商。

### 7.1 自定义服务器示例

```js
// server.js
const { createServer } = require('http');
const { parse } = require('url');
const next = require('next');

const dev = process.env.NODE_ENV !== 'production';
const app = next({ dev });
const handle = app.getRequestHandler();

app.prepare().then(() => {
  createServer((req, res) => {
    const parsedUrl = parse(req.url, true);
    const { pathname, query } = parsedUrl;

    // 自定义路由处理
    if (pathname === '/custom') {
      return app.render(req, res, '/custom-page', query);
    }

    // 让 Next.js 处理其他路由
    handle(req, res, parsedUrl);
  }).listen(3000, (err) => {
    if (err) throw err;
    console.log('> Ready on http://localhost:3000');
  });
});
```

### 7.2 部署自定义服务器

1. **构建应用**
   ```bash
   npm run build
   ```

2. **使用 PM2 管理进程**
   ```bash
   # 安装 PM2
   npm install -g pm2

   # 启动应用
   pm2 start server.js --name "next-app"

   # 设置开机自启
   pm2 startup
   pm2 save
   ```

## 8. 部署最佳实践

### 8.1 环境变量配置

- 使用 `.env.production` 文件配置生产环境变量
- 在部署平台上配置敏感环境变量，避免硬编码到代码中
- 使用不同的环境变量区分开发、测试和生产环境

### 8.2 性能优化

- 启用压缩：使用 Gzip 或 Brotli 压缩静态资源
- 配置缓存策略：设置适当的缓存头，减少重复请求
- 优化图像：使用 `next/image` 组件自动优化图像
- 使用 CDN：分发静态资源，提高全球访问速度

### 8.3 监控和日志

- 集成监控工具：如 New Relic、Datadog、Sentry 等
- 配置日志记录：记录应用日志和错误信息
- 设置告警：监控应用性能和可用性，及时发现问题

### 8.4 安全最佳实践

- 使用 HTTPS：配置 SSL 证书，确保数据传输安全
- 定期更新依赖：修复安全漏洞
- 配置 CORS：限制跨域请求
- 实现身份验证和授权：保护敏感 API 端点
- 使用安全的环境变量：避免暴露敏感信息

### 8.5 CI/CD 集成

- 配置持续集成：使用 GitHub Actions、GitLab CI、Jenkins 等
- 自动化测试：在部署前运行单元测试、集成测试和端到端测试
- 自动化部署：代码合并后自动部署到测试环境，手动或自动部署到生产环境

## 9. 部署检查清单

- [ ] 确保 `next.config.js` 配置正确
- [ ] 配置生产环境变量
- [ ] 构建应用并测试
- [ ] 配置域名和 SSL 证书
- [ ] 配置 CDN（如果需要）
- [ ] 配置监控和日志
- [ ] 配置 CI/CD 流程
- [ ] 测试部署后的应用
- [ ] 设置备份和恢复策略

## 10. 常见部署问题及解决方案

### 10.1 构建失败

**问题**：部署时构建失败

**解决方案**：
- 检查依赖是否正确安装
- 检查 Node.js 版本是否符合要求
- 检查 `next.config.js` 配置是否正确
- 查看构建日志，定位具体错误

### 10.2 路由问题

**问题**：部署后路由无法访问，返回 404

**解决方案**：
- 确保使用正确的部署方式（静态导出 vs 服务器渲染）
- 配置正确的路由重写规则
- 检查 `next.config.js` 中的路由配置

### 10.3 环境变量问题

**问题**：应用无法访问环境变量

**解决方案**：
- 确保环境变量配置正确
- 检查环境变量名称是否正确
- 确保敏感环境变量在部署平台上配置，而不是硬编码到代码中

### 10.4 性能问题

**问题**：部署后应用加载缓慢

**解决方案**：
- 启用压缩和缓存
- 优化图像和静态资源
- 使用 CDN 分发静态资源
- 优化代码，减少 bundle 大小

## 11. 总结

Next.js 应用可以部署到多种平台，选择合适的部署方式取决于应用的需求、预算和团队偏好。Vercel 提供了最佳的 Next.js 支持和性能优化，适合大多数 Next.js 应用。对于需要更多自定义和控制的应用，可以选择部署到 AWS、Google Cloud 或自定义服务器。

部署是应用开发的重要组成部分，掌握部署技巧对于确保应用的可用性、性能和安全性至关重要。