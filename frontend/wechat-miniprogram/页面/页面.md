# 微信小程序页面开发

## 1. 页面结构

### 1.1 页面文件组成
微信小程序的页面由四个文件组成，它们必须具有相同的文件名：

| 文件类型 | 扩展名 | 作用 |
|---------|--------|------|
| 模板文件 | .wxml | 定义页面结构，类似于 HTML |
| 样式文件 | .wxss | 定义页面样式，类似于 CSS |
| 逻辑文件 | .js | 处理页面逻辑，包括数据、事件、生命周期等 |
| 配置文件 | .json | 配置页面窗口表现，优先级高于 app.json |

### 1.2 页面目录结构
```
pages/
├── index/
│   ├── index.js     # 页面逻辑
│   ├── index.json   # 页面配置
│   ├── index.wxml   # 页面结构
│   └── index.wxss   # 页面样式
└── logs/
    ├── logs.js
    ├── logs.json
    ├── logs.wxml
    └── logs.wxss
```

## 2. WXML 模板

### 2.1 基础语法

#### 2.1.1 数据绑定
```wxml
<!-- 绑定单个变量 -->
<view>{{ message }}</view>

<!-- 绑定属性 -->
<view id="item-{{id}}"></view>

<!-- 绑定布尔值 -->
<view wx:if="{{condition}}"></view>
```

#### 2.1.2 列表渲染
```wxml
<!-- 使用 wx:for 渲染列表 -->
<view wx:for="{{array}}" wx:key="id">
  {{index}}: {{item.message}}
</view>

<!-- 自定义列表项变量名 -->
<view wx:for="{{array}}" wx:for-item="fruit" wx:for-index="idx">
  {{idx}}: {{fruit.name}}
</view>
```

#### 2.1.3 条件渲染
```wxml
<!-- 单个条件 -->
<view wx:if="{{condition}}">True</view>

<!-- 条件分支 -->
<view wx:if="{{length > 5}}">1</view>
<view wx:elif="{{length > 2}}">2</view>
<view wx:else>3</view>

<!-- 使用 block 包装多个组件 -->
<block wx:if="{{true}}">
  <view>view1</view>
  <view>view2</view>
</block>
```

### 2.2 模板与引用

#### 2.2.1 定义模板
```wxml
<!-- 在 template.wxml 中定义 -->
<template name="msgItem">
  <view>
    <text>{{index}}: {{msg}}</text>
    <text>Time: {{time}}</text>
  </view>
</template>
```

#### 2.2.2 使用模板
```wxml
<!-- 引用模板文件 -->
<import src="../../templates/template.wxml"/>

<!-- 使用模板 -->
<template is="msgItem" data="{{...item}}"/>
```

#### 2.2.3 包含文件
```wxml
<!-- 包含公共头部 -->
<include src="../../common/header.wxml"/>
```

## 3. WXSS 样式

### 3.1 基础语法
```wxss
/* 全局样式 */
.container {
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* 组件样式 */
.title {
  font-size: 20px;
  color: #333;
  margin: 20rpx 0;
}
```

### 3.2 尺寸单位
- `rpx`：响应式像素，根据屏幕宽度自适应
  - 屏幕宽度为750rpx
  - 1rpx = 屏幕宽度 / 750
- `px`：固定像素，不会自适应

### 3.3 样式导入
```wxss
/* 导入外部样式文件 */
@import "../../common/common.wxss";

/* 本地样式 */
.page {
  background-color: #f5f5f5;
}
```

## 4. JavaScript 逻辑

### 4.1 页面生命周期

#### 4.1.1 生命周期函数
```javascript
Page({
  // 页面初始化，只触发一次
  onLoad(options) {
    console.log('页面加载', options);
  },
  
  // 页面显示，每次打开页面都会触发
  onShow() {
    console.log('页面显示');
  },
  
  // 页面初次渲染完成，只触发一次
  onReady() {
    console.log('页面渲染完成');
  },
  
  // 页面隐藏，当navigateTo或底部tab切换时触发
  onHide() {
    console.log('页面隐藏');
  },
  
  // 页面卸载，当redirectTo或navigateBack时触发
  onUnload() {
    console.log('页面卸载');
  },
  
  // 下拉刷新，需要在app.json或页面json中配置enablePullDownRefresh
  onPullDownRefresh() {
    console.log('下拉刷新');
    // 结束下拉刷新
    wx.stopPullDownRefresh();
  },
  
  // 上拉触底
  onReachBottom() {
    console.log('上拉触底');
  },
  
  // 页面滚动
  onPageScroll(options) {
    console.log('页面滚动', options.scrollTop);
  }
});
```

#### 4.1.2 生命周期流程图
```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   onLoad    │────▶│   onShow    │────▶│   onReady   │────▶│   onHide    │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
         │                                     ▲                     │
         ▼                                     │                     ▼
┌─────────────┐                           ┌─────────────┐     ┌─────────────┐
│   onUnload  │◀───────────────────────────│ onPullDown  │     │ onReachBottom│
└─────────────┘                           │  Refresh    │     └─────────────┘
                                          └─────────────┘
```

### 4.2 页面数据管理

#### 4.2.1 数据定义与修改
```javascript
Page({
  // 初始数据
  data: {
    message: 'Hello World',
    list: [1, 2, 3],
    userInfo: {
      name: '张三',
      age: 20
    }
  },
  
  // 修改数据
  changeData() {
    // 直接修改数据不会触发视图更新
    // this.data.message = 'New Message';
    
    // 必须使用 setData 方法修改数据
    this.setData({
      message: 'New Message',
      'userInfo.name': '李四' // 修改对象属性
    });
  }
});
```

#### 4.2.2 setData 注意事项
- 不要直接修改 this.data，要使用 this.setData
- setData 是异步的，修改后不会立即反映到 this.data 中
- 频繁调用 setData 会影响性能
- 单次设置的数据不能超过1024KB

### 4.3 事件处理

#### 4.3.1 绑定事件
```wxml
<!-- 绑定点击事件 -->
<button bindtap="handleTap">点击我</button>

<!-- 绑定触摸事件 -->
<view bindtouchstart="handleTouchStart">触摸开始</view>

<!-- 绑定事件并传递参数 -->
<view bindtap="handleItemTap" data-id="1">项目1</view>
```

#### 4.3.2 事件处理函数
```javascript
Page({
  // 简单事件处理
  handleTap() {
    console.log('按钮被点击');
  },
  
  // 带参数的事件处理
  handleItemTap(e) {
    // 通过 currentTarget.dataset 获取传递的参数
    const id = e.currentTarget.dataset.id;
    console.log('点击了项目', id);
  },
  
  // 触摸事件处理
  handleTouchStart(e) {
    console.log('触摸开始', e.touches[0].clientX, e.touches[0].clientY);
  }
});
```

#### 4.3.3 事件冒泡与捕获
```wxml
<!-- 事件冒泡 -->
<view bindtap="outer">
  <view bindtap="inner">点击我</view>
</view>

<!-- 阻止事件冒泡 -->
<view bindtap="outer">
  <view catchtap="inner">点击我</view>
</view>

<!-- 事件捕获 -->
<view capture-bind:tap="outer">
  <view capture-bind:tap="inner">点击我</view>
</view>
```

## 5. 页面配置

### 5.1 配置项
```json
{
  "navigationBarTitleText": "页面标题",
  "navigationBarBackgroundColor": "#ffffff",
  "navigationBarTextStyle": "black",
  "backgroundColor": "#eeeeee",
  "backgroundTextStyle": "light",
  "enablePullDownRefresh": false,
  "onReachBottomDistance": 50,
  "disableScroll": false,
  "usingComponents": {}
}
```

### 5.2 常用配置说明
| 配置项 | 类型 | 默认值 | 说明 |
|-------|------|--------|------|
| navigationBarTitleText | String | | 导航栏标题文字内容 |
| navigationBarBackgroundColor | HexColor | #000000 | 导航栏背景颜色 |
| navigationBarTextStyle | String | white | 导航栏标题颜色，仅支持 black/white |
| backgroundColor | HexColor | #ffffff | 窗口的背景色 |
| backgroundTextStyle | String | dark | 下拉 loading 的样式，仅支持 dark/light |
| enablePullDownRefresh | Boolean | false | 是否开启下拉刷新 |
| onReachBottomDistance | Number | 50 | 页面上拉触底事件触发时距页面底部距离 |
| disableScroll | Boolean | false | 设置为 true 则页面整体不能上下滚动 |
| usingComponents | Object | | 页面自定义组件配置 |

## 6. 页面路由

### 6.1 路由方式
微信小程序提供了以下路由方式：

| 方法 | 描述 | 页面栈 |
|-----|------|--------|
| wx.navigateTo | 保留当前页面，跳转到应用内的某个页面 | 增加 |
| wx.redirectTo | 关闭当前页面，跳转到应用内的某个页面 | 替换 |
| wx.reLaunch | 关闭所有页面，打开到应用内的某个页面 | 重置 |
| wx.switchTab | 跳转到 tabBar 页面，并关闭其他所有非 tabBar 页面 | 切换 |
| wx.navigateBack | 关闭当前页面，返回上一页面或多级页面 | 减少 |

### 6.2 路由使用示例
```javascript
// 保留当前页面，跳转到详情页
wx.navigateTo({
  url: '/pages/detail/detail?id=1'
});

// 关闭当前页面，跳转到登录页
wx.redirectTo({
  url: '/pages/login/login'
});

// 返回上一页
wx.navigateBack({
  delta: 1
});

// 跳转到 tabBar 页面
wx.switchTab({
  url: '/pages/index/index'
});
```

### 6.3 获取当前页面栈
```javascript
// 获取页面栈
const pages = getCurrentPages();
// 获取当前页面
const currentPage = pages[pages.length - 1];
// 获取上一页面
const prevPage = pages[pages.length - 2];

// 可以直接修改上一页面的数据
prevPage.setData({
  message: '从详情页返回'
});
```

## 7. 组件化开发

### 7.1 自定义组件

#### 7.1.1 创建组件
```
components/
└── my-component/
    ├── my-component.js
    ├── my-component.json
    ├── my-component.wxml
    └── my-component.wxss
```

#### 7.1.2 组件配置
```json
// my-component.json
{
  "component": true,
  "usingComponents": {}
}
```

#### 7.1.3 组件使用
```json
// 页面配置文件 index.json
{
  "usingComponents": {
    "my-component": "../../components/my-component/my-component"
  }
}
```

```wxml
<!-- 页面中使用组件 -->
<my-component title="自定义组件" bind:myevent="handleComponentEvent"></my-component>
```

### 7.2 组件通信

#### 7.2.1 父组件向子组件传递数据
```javascript
// 子组件 my-component.js
Component({
  properties: {
    title: {
      type: String,
      value: '默认标题'
    },
    count: {
      type: Number,
      value: 0
    }
  }
});
```

```wxml
<!-- 父组件中使用 -->
<my-component title="父组件传递的标题" count="5"></my-component>
```

#### 7.2.2 子组件向父组件传递事件
```javascript
// 子组件 my-component.js
Component({
  methods: {
    onTap() {
      // 触发自定义事件
      this.triggerEvent('myevent', {
        data: '子组件传递的数据'
      });
    }
  }
});
```

```javascript
// 父组件 index.js
Page({
  handleComponentEvent(e) {
    console.log('收到子组件事件', e.detail.data);
  }
});
```

## 8. 页面性能优化

### 8.1 减少 setData 调用
- 合并多次 setData 调用
- 避免在 onPageScroll 中使用 setData
- 只设置需要改变的数据

### 8.2 优化列表渲染
- 使用 wx:key 提高列表渲染性能
- 避免在列表项中使用复杂的 WXML 结构
- 实现虚拟列表处理长列表

### 8.3 优化图片加载
- 使用合适尺寸的图片
- 实现图片懒加载
- 使用云开发的图片压缩功能

### 8.4 合理使用组件
- 拆分复杂页面为多个组件
- 避免组件层级过深
- 合理使用自定义组件和原生组件

## 9. 常见问题

### 9.1 页面数据不更新
- 检查是否使用了 setData 方法
- 检查 setData 的调用时机
- 检查数据路径是否正确

### 9.2 事件不触发
- 检查事件绑定语法是否正确
- 检查事件处理函数是否存在
- 检查是否有事件阻止冒泡

### 9.3 页面跳转失败
- 检查页面路径是否正确
- 检查页面是否在 app.json 中注册
- 检查跳转方式是否正确

## 10. 最佳实践

### 10.1 代码组织
- 按功能模块划分页面
- 合理使用组件化开发
- 抽取公共逻辑到 utils 目录

### 10.2 数据管理
- 避免在页面中存储过多数据
- 合理使用缓存（wx.setStorage）
- 及时清理定时器和监听器

### 10.3 用户体验
- 合理使用加载提示（wx.showLoading）
- 实现下拉刷新和上拉加载
- 优化页面切换动画

### 10.4 开发规范
- 统一命名规范
- 注释清晰
- 代码简洁
- 定期代码审查

## 11. 示例代码

### 11.1 完整页面示例

#### 11.1.1 index.wxml
```wxml
<view class="container">
  <view class="header">
    <text class="title">{{title}}</text>
  </view>
  
  <view class="content">
    <view class="user-info">
      <image class="avatar" src="{{userInfo.avatarUrl}}" mode="aspectFill"></image>
      <text class="nickname">{{userInfo.nickName}}</text>
    </view>
    
    <view class="list">
      <view wx:for="{{list}}" wx:key="id" class="list-item" bindtap="handleItemTap" data-id="{{item.id}}">
        <text class="item-title">{{item.title}}</text>
        <text class="item-desc">{{item.desc}}</text>
      </view>
    </view>
    
    <button class="btn" bindtap="handleAddItem">添加项目</button>
  </view>
</view>
```

#### 11.1.2 index.wxss
```wxss
.container {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  background-color: #f5f5f5;
}

.header {
  background-color: #07c160;
  padding: 30rpx;
  text-align: center;
}

.title {
  color: #fff;
  font-size: 32rpx;
  font-weight: bold;
}

.content {
  flex: 1;
  padding: 30rpx;
}

.user-info {
  display: flex;
  align-items: center;
  margin-bottom: 30rpx;
  padding: 20rpx;
  background-color: #fff;
  border-radius: 10rpx;
  box-shadow: 0 2rpx 10rpx rgba(0, 0, 0, 0.1);
}

.avatar {
  width: 100rpx;
  height: 100rpx;
  border-radius: 50%;
  margin-right: 20rpx;
}

.nickname {
  font-size: 28rpx;
  color: #333;
}

.list {
  margin-bottom: 30rpx;
}

.list-item {
  background-color: #fff;
  padding: 30rpx;
  margin-bottom: 20rpx;
  border-radius: 10rpx;
  box-shadow: 0 2rpx 10rpx rgba(0, 0, 0, 0.1);
}

.item-title {
  display: block;
  font-size: 28rpx;
  color: #333;
  margin-bottom: 10rpx;
  font-weight: bold;
}

.item-desc {
  font-size: 24rpx;
  color: #666;
  line-height: 1.5;
}

.btn {
  width: 100%;
  background-color: #07c160;
  color: #fff;
  border-radius: 10rpx;
}
```

#### 11.1.3 index.js
```javascript
Page({
  data: {
    title: '微信小程序页面示例',
    userInfo: {
      avatarUrl: 'https://via.placeholder.com/100',
      nickName: '微信用户'
    },
    list: [
      {
        id: 1,
        title: '项目1',
        desc: '这是第一个项目的描述'
      },
      {
        id: 2,
        title: '项目2',
        desc: '这是第二个项目的描述'
      },
      {
        id: 3,
        title: '项目3',
        desc: '这是第三个项目的描述'
      }
    ]
  },
  
  onLoad() {
    console.log('页面加载完成');
  },
  
  handleItemTap(e) {
    const id = e.currentTarget.dataset.id;
    wx.showToast({
      title: `点击了项目 ${id}`,
      icon: 'none'
    });
    
    // 跳转到详情页
    wx.navigateTo({
      url: `/pages/detail/detail?id=${id}`
    });
  },
  
  handleAddItem() {
    const newItem = {
      id: this.data.list.length + 1,
      title: `项目${this.data.list.length + 1}`,
      desc: `这是第${this.data.list.length + 1}个项目的描述`
    };
    
    this.setData({
      list: [...this.data.list, newItem]
    });
    
    wx.showToast({
      title: '添加成功',
      icon: 'success'
    });
  }
});
```

#### 11.1.4 index.json
```json
{
  "navigationBarTitleText": "页面示例",
  "navigationBarBackgroundColor": "#07c160",
  "navigationBarTextStyle": "white",
  "backgroundColor": "#f5f5f5"
}
```

## 12. 总结

微信小程序页面开发是小程序开发的核心部分，掌握页面的结构、生命周期、数据管理、事件处理和组件化开发等知识点是开发高质量小程序的基础。通过合理的代码组织、性能优化和用户体验设计，可以开发出功能丰富、性能优异的微信小程序。

在实际开发中，建议：
1. 遵循微信小程序的开发规范
2. 合理使用组件化开发提高代码复用性
3. 注重性能优化，提高小程序的运行效率
4. 关注用户体验，提供流畅的交互效果
5. 不断学习微信小程序的新特性和最佳实践

通过持续学习和实践，你将能够开发出优秀的微信小程序应用。