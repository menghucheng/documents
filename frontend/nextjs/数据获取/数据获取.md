# Next.js 数据获取

## 1. 数据获取概述

Next.js 提供了多种数据获取方式，允许开发者在不同的阶段获取数据，包括：

- **构建时数据获取**：使用 `getStaticProps` 在构建时获取数据
- **请求时数据获取**：使用 `getServerSideProps` 在每个请求时获取数据
- **客户端数据获取**：使用 React Hooks（如 `useEffect`）在客户端获取数据
- **静态路径生成**：使用 `getStaticPaths` 为动态路由生成静态路径

## 2. 构建时数据获取 (getStaticProps)

`getStaticProps` 用于在构建时获取数据，生成静态 HTML 页面。适用于数据不经常变化的场景，如博客文章、产品列表等。

### 2.1 基本用法

```jsx
// pages/index.js
export async function getStaticProps() {
  // 从 API 获取数据
  const res = await fetch('https://api.example.com/posts');
  const posts = await res.json();

  // 返回数据作为组件的 props
  return {
    props: {
      posts,
    },
    // 可选：设置重验证时间（秒），启用增量静态再生
    revalidate: 60,
  };
}

function Home({ posts }) {
  return (
    <div>
      <h1>博客文章</h1>
      <ul>
        {posts.map((post) => (
          <li key={post.id}>{post.title}</li>
        ))}
      </ul>
    </div>
  );
}

export default Home;
```

### 2.2 增量静态再生 (ISR)

通过 `revalidate` 参数启用增量静态再生，允许在构建后更新静态页面：

```jsx
export async function getStaticProps() {
  // 获取数据
  const posts = await fetchPosts();

  return {
    props: {
      posts,
    },
    // 每60秒重新生成页面（如果有请求）
    revalidate: 60,
  };
}
```

## 3. 请求时数据获取 (getServerSideProps)

`getServerSideProps` 用于在每个请求时获取数据，适用于数据经常变化或需要访问请求上下文的场景。

### 3.1 基本用法

```jsx
// pages/profile.js
export async function getServerSideProps(context) {
  // 从请求上下文获取用户 ID
  const { userId } = context.params;
  
  // 获取用户数据
  const res = await fetch(`https://api.example.com/users/${userId}`);
  const user = await res.json();

  // 返回数据作为组件的 props
  return {
    props: {
      user,
    },
  };
}

function Profile({ user }) {
  return (
    <div>
      <h1>{user.name} 的个人资料</h1>
      <p>{user.bio}</p>
    </div>
  );
}

export default Profile;
```

### 3.2 请求上下文 (context) 参数

`context` 参数包含以下属性：

- `params`：路由参数
- `req`：HTTP 请求对象
- `res`：HTTP 响应对象
- `query`：查询参数
- `preview`：是否处于预览模式
- `previewData`：预览数据
- `resolvedUrl`：解析后的 URL
- `locale`：当前区域设置
- `locales`：所有可用区域设置
- `defaultLocale`：默认区域设置

## 4. 客户端数据获取

对于需要在客户端动态获取数据的场景，可以使用 React 的 `useEffect` Hook 或其他客户端数据获取库。

### 4.1 使用 useEffect

```jsx
// pages/dashboard.js
import { useState, useEffect } from 'react';

function Dashboard() {
  const [data, setData] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    async function fetchData() {
      const res = await fetch('/api/data');
      const result = await res.json();
      setData(result);
      setLoading(false);
    }

    fetchData();
  }, []);

  if (loading) {
    return <div>加载中...</div>;
  }

  return (
    <div>
      <h1>仪表板数据</h1>
      <ul>
        {data.map((item) => (
          <li key={item.id}>{item.name}</li>
        ))}
      </ul>
    </div>
  );
}

export default Dashboard;
```

### 4.2 使用 SWR 库

SWR 是 Next.js 团队开发的数据获取库，提供了缓存、重验证、聚焦重新获取等功能。

```jsx
// pages/dashboard.js
import useSWR from 'swr';

const fetcher = (url) => fetch(url).then((res) => res.json());

function Dashboard() {
  const { data, error } = useSWR('/api/data', fetcher);

  if (error) return <div>获取数据失败</div>;
  if (!data) return <div>加载中...</div>;

  return (
    <div>
      <h1>仪表板数据</h1>
      <ul>
        {data.map((item) => (
          <li key={item.id}>{item.name}</li>
        ))}
      </ul>
    </div>
  );
}

export default Dashboard;
```

## 5. 静态路径生成 (getStaticPaths)

`getStaticPaths` 用于为动态路由生成静态路径，与 `getStaticProps` 配合使用。

### 5.1 基本用法

```jsx
// pages/posts/[id].js
export async function getStaticPaths() {
  // 获取所有文章 ID
  const res = await fetch('https://api.example.com/posts');
  const posts = await res.json();

  // 生成路径数组
  const paths = posts.map((post) => ({
    params: { id: post.id.toString() },
  }));

  return {
    paths,
    // 可选：设置未找到的路径如何处理
    // 'fallback: false' 表示未生成的路径返回 404
    // 'fallback: true' 表示未生成的路径在请求时生成
    // 'fallback: blocking' 表示未生成的路径在请求时阻塞生成
    fallback: false,
  };
}

export async function getStaticProps({ params }) {
  // 根据 ID 获取文章数据
  const res = await fetch(`https://api.example.com/posts/${params.id}`);
  const post = await res.json();

  return {
    props: {
      post,
    },
  };
}

function Post({ post }) {
  return (
    <div>
      <h1>{post.title}</h1>
      <div dangerouslySetInnerHTML={{ __html: post.content }} />
    </div>
  );
}

export default Post;
```

### 5.2 fallback 选项

- **`fallback: false`**：仅生成 `paths` 中指定的路径，其他路径返回 404
- **`fallback: true`**：生成 `paths` 中指定的路径，其他路径在请求时生成（显示加载状态）
- **`fallback: blocking`**：生成 `paths` 中指定的路径，其他路径在请求时阻塞生成（不显示加载状态）

## 6. 数据获取方式比较

| 特性 | getStaticProps | getServerSideProps | 客户端数据获取 |
|------|----------------|-------------------|----------------|
| 数据获取时机 | 构建时 | 每个请求时 | 客户端渲染后 |
| 生成页面类型 | 静态 HTML | 动态 HTML | 静态 HTML + 客户端渲染 |
| SEO 友好 | ✅ 优秀 | ✅ 优秀 | ⚠️ 一般（依赖 JS 渲染） |
| 性能 | ✅ 优秀（CDN 缓存） | ⚠️ 一般（每次请求渲染） | ⚠️ 一般（需要两次请求） |
| 适用场景 | 数据不经常变化 | 数据经常变化 | 动态交互数据 |
| 访问请求上下文 | ❌ 不支持 | ✅ 支持 | ❌ 不支持（直接访问） |
| 访问环境变量 | ✅ 支持 | ✅ 支持 | ✅ 仅支持客户端环境变量 |

## 7. 环境变量

Next.js 支持不同环境的环境变量配置：

### 7.1 配置环境变量

| 文件名 | 适用环境 | 访问方式 |
|--------|----------|----------|
| `.env` | 所有环境 | `process.env.VARIABLE_NAME` |
| `.env.local` | 所有环境（本地） | `process.env.VARIABLE_NAME` |
| `.env.development` | 开发环境 | `process.env.VARIABLE_NAME` |
| `.env.production` | 生产环境 | `process.env.VARIABLE_NAME` |
| `.env.development.local` | 开发环境（本地） | `process.env.VARIABLE_NAME` |
| `.env.production.local` | 生产环境（本地） | `process.env.VARIABLE_NAME` |

### 7.2 客户端环境变量

以 `NEXT_PUBLIC_` 前缀开头的环境变量可以在客户端访问：

```js
// .env.local
NEXT_PUBLIC_API_URL=https://api.example.com
```

```jsx
// 客户端组件中访问
function Component() {
  return <div>API URL: {process.env.NEXT_PUBLIC_API_URL}</div>;
}
```

## 8. API 路由数据获取

在 API 路由中，可以直接获取数据并返回 JSON 响应：

```jsx
// pages/api/posts.js
export default async function handler(req, res) {
  // 获取查询参数
  const { page = 1, limit = 10 } = req.query;

  try {
    // 从数据库或外部 API 获取数据
    const posts = await fetchPosts(page, limit);
    const total = await getTotalPosts();

    res.status(200).json({
      posts,
      total,
      page: parseInt(page),
      limit: parseInt(limit),
    });
  } catch (error) {
    res.status(500).json({ error: '获取数据失败' });
  }
}
```

## 9. 数据获取最佳实践

### 9.1 选择合适的数据获取方式

- 对于静态内容，优先使用 `getStaticProps`
- 对于动态内容，使用 `getServerSideProps` 或客户端数据获取
- 对于介于两者之间的内容，考虑使用 `getStaticProps` 配合 `revalidate`（ISR）

### 9.2 优化数据获取

- 减少 API 请求次数，合并相关数据的请求
- 使用缓存机制，避免重复获取相同数据
- 只获取必要的数据，避免传输过大的数据集
- 使用分页或无限滚动，避免一次性获取大量数据

### 9.3 处理错误和加载状态

- 在客户端数据获取中，始终处理加载状态和错误状态
- 使用骨架屏（Skeleton）提升用户体验
- 在服务器端数据获取中，使用 `notFound` 或 `redirect` 处理特殊情况

### 9.4 安全考虑

- 不要在客户端暴露敏感数据
- 使用服务器端数据获取处理认证和授权
- 验证和清理所有用户输入
- 使用 HTTPS 保护数据传输

## 10. 总结

Next.js 提供了灵活的数据获取方式，允许开发者根据不同的场景选择合适的方案。通过合理使用 `getStaticProps`、`getServerSideProps`、`getStaticPaths` 和客户端数据获取，可以构建高性能、SEO 友好的应用。

掌握数据获取是 Next.js 开发的重要部分，合理的数据获取策略可以显著提升应用的性能和用户体验。