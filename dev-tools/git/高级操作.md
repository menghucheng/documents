# Git 高级操作

## 1. 标签管理

标签用于标记特定的提交，通常用于版本发布。

### 1.1 查看标签

**语法：**
```bash
$ git tag
```

**输出示例：**
```
v1.0.0
v1.1.0
v2.0.0
```

**常用选项：**
- `-l` 或 `--list`：列出匹配模式的标签
- `-n`：显示标签的注释信息

**示例：**
```bash
$ git tag -l "v1.*"
```

**输出示例：**
```
v1.0.0
v1.1.0
```

### 1.2 创建标签

#### 1.2.1 轻量标签

轻量标签只是一个指向特定提交的指针，没有额外信息。

**语法：**
```bash
$ git tag <标签名> <提交ID>
```

**示例：**
```bash
$ git tag v1.0.0 1a2b3c4
```

#### 1.2.2 带注释标签

带注释标签包含标签信息、作者、时间戳等，是推荐的标签类型。

**语法：**
```bash
$ git tag -a <标签名> -m "标签注释" <提交ID>
```

**示例：**
```bash
$ git tag -a v1.0.0 -m "Version 1.0.0 release" 1a2b3c4
```

**输出示例：**
```
Tagging 1a2b3c4 with tag 'v1.0.0' and message 'Version 1.0.0 release'
```

### 1.3 查看标签信息

**语法：**
```bash
$ git show <标签名>
```

**示例：**
```bash
$ git show v1.0.0
```

**输出示例：**
```
tag v1.0.0
Tagger: Your Name <your.email@example.com>
Date:   Mon Dec 8 22:00:00 2025 +0800

Version 1.0.0 release

commit 1a2b3c4d5e6f7g8h9i0j1k2l3m4n5o6p7q8r9s0t
Author: Your Name <your.email@example.com>
Date:   Mon Dec 8 21:00:00 2025 +0800

    Initial release

    ...
```

### 1.4 删除标签

**语法：**
```bash
$ git tag -d <标签名>
```

**示例：**
```bash
$ git tag -d v1.0.0
```

**输出示例：**
```
Deleted tag 'v1.0.0' (was 1a2b3c4)
```

## 2. 重置（Reset）

重置用于修改 HEAD 指针的位置，以及调整暂存区和工作目录的状态。

### 2.1 `git reset`

**语法：**
```bash
$ git reset <选项> <提交ID>
```

**常用选项：**

1. **--soft**：仅回退 HEAD 指针，保留暂存区和工作目录
   - 用于撤销最近的 commit，但保留修改内容

2. **--mixed**：回退 HEAD 指针和暂存区，保留工作目录（默认）
   - 用于撤销最近的 commit 和 add，但保留修改内容

3. **--hard**：回退 HEAD 指针、暂存区和工作目录，丢弃所有修改
   - 用于完全回退到指定提交，丢弃所有未提交的修改

**示例：**

1. 软重置：
```bash
$ git reset --soft HEAD~1
```

2. 混合重置（默认）：
```bash
$ git reset HEAD~1
```

3. 硬重置：
```bash
$ git reset --hard HEAD~1
```

**输出示例：**
```
HEAD is now at 0t9s8r7 Initial commit
```

## 3. 恢复（Revert）

恢复用于创建一个新的提交，撤销指定提交的修改，而不修改提交历史。

### 3.1 `git revert`

**语法：**
```bash
$ git revert <提交ID>
```

**示例：**
```bash
$ git revert 1a2b3c4
```

**输出示例：**
```
[main 7a8b9c0] Revert "Add new feature"
 1 file changed, 2 deletions(-)
```

**常用选项：**
- `-n` 或 `--no-commit`：撤销修改但不自动提交
- `--no-edit`：使用默认的恢复提交信息，不打开编辑器

**示例：**
```bash
$ git revert --no-edit 1a2b3c4
```

## 4. 变基（Rebase）

变基用于将一个分支的修改应用到另一个分支上，使提交历史更加线性。

### 4.1 `git rebase`

**语法：**
```bash
$ git rebase <目标分支> <当前分支>
```

**常用用法：**

1. 将当前分支变基到目标分支：
```bash
$ git checkout feature-branch
$ git rebase main
```

2. 交互式变基，用于修改提交历史：
```bash
$ git rebase -i HEAD~3
```

**交互式变基示例：**
```
pick 1a2b3c4 Add feature A
pick 4g5h6i7 Add feature B
pick 7j8k9l0 Add feature C

# Rebase 0t9s8r7..7j8k9l0 onto 0t9s8r7 (3 commands)
#
# Commands:
# p, pick <commit> = use commit
# r, reword <commit> = use commit, but edit the commit message
# e, edit <commit> = use commit, but stop for amending
# s, squash <commit> = use commit, but meld into previous commit
# f, fixup <commit> = like "squash", but discard this commit's log message
# x, exec <command> = run command (the rest of the line) using shell
# b, break = stop here (continue rebase later with 'git rebase --continue')
# d, drop <commit> = remove commit
# l, label <label> = label current HEAD with a name
# t, reset <label> = reset HEAD to a label
# m, merge [-C <commit> | -c <commit>] <label> [# <oneline>]
# .       create a merge commit using the original merge commit's
# .       message (or the oneline, if no original merge commit was
# .       specified). Use -c <commit> to reword the commit message.
```

**变基与合并的区别：**

- **合并**：创建一个新的合并提交，保留完整的分支历史
- **变基**：将修改应用到目标分支，使提交历史更加线性

### 4.2 解决变基冲突

当变基时遇到冲突，解决步骤与合并冲突类似：

1. 查看冲突文件：
```bash
$ git status
```

2. 编辑冲突文件，手动解决冲突

3. 将解决后的文件添加到暂存区：
```bash
$ git add <冲突文件>
```

4. 继续变基：
```bash
$ git rebase --continue
```

5. 或中止变基：
```bash
$ git rebase --abort
```

## 5. 樱桃挑选（Cherry-pick）

樱桃挑选用于将单个或多个提交从一个分支复制到另一个分支。

### 5.1 `git cherry-pick`

**语法：**
```bash
$ git cherry-pick <提交ID>
```

**示例：**
```bash
$ git cherry-pick 1a2b3c4
```

**输出示例：**
```
[main 7a8b9c0] Add feature A
 Date: Mon Dec 8 21:00:00 2025 +0800
 1 file changed, 5 insertions(+)
```

**常用选项：**
- `-n` 或 `--no-commit`：应用修改但不自动提交
- `-x`：在提交信息中添加原提交的 SHA-1 值
- `--continue`：继续樱桃挑选，用于解决冲突后
- `--abort`：中止樱桃挑选

**示例：**

1. 复制多个提交：
```bash
$ git cherry-pick 1a2b3c4 4g5h6i7 7j8k9l0
```

2. 复制一个范围的提交：
```bash
$ git cherry-pick 1a2b3c4..7j8k9l0
```

## 6. 储藏（Stash）

储藏用于保存当前工作目录的修改，以便切换到其他分支或执行其他操作。

### 6.1 查看储藏列表

**语法：**
```bash
$ git stash list
```

**输出示例：**
```
stash@{0}: WIP on main: 1a2b3c4 Add feature A
stash@{1}: WIP on feature-branch: 4g5h6i7 Add feature B
```

### 6.2 创建储藏

**语法：**
```bash
$ git stash save "储藏注释"
```

**示例：**
```bash
$ git stash save "Work in progress on feature A"
```

**输出示例：**
```
Saved working directory and index state On main: Work in progress on feature A
```

### 6.3 应用储藏

#### 6.3.1 `git stash apply`

应用储藏的修改，但不删除储藏。

**语法：**
```bash
$ git stash apply <储藏名>
```

**示例：**
```bash
$ git stash apply stash@{0}
```

#### 6.3.2 `git stash pop`

应用储藏的修改，并删除储藏。

**语法：**
```bash
$ git stash pop <储藏名>
```

**示例：**
```bash
$ git stash pop
```

### 6.4 删除储藏

#### 6.4.1 删除指定储藏

**语法：**
```bash
$ git stash drop <储藏名>
```

**示例：**
```bash
$ git stash drop stash@{0}
```

**输出示例：**
```
dropped refs/stash@{0} (5d6e7f89a0b1c2d3e4f5g6h7i8j9k0l1m2n3o4p5)
```

#### 6.4.2 删除所有储藏

**语法：**
```bash
$ git stash clear
```

## 7. 子模块（Submodule）

子模块用于将一个 Git 仓库作为另一个 Git 仓库的子目录。

### 7.1 添加子模块

**语法：**
```bash
$ git submodule add <远程仓库URL> <本地路径>
```

**示例：**
```bash
$ git submodule add https://github.com/user/lib.git lib
```

### 7.2 初始化子模块

**语法：**
```bash
$ git submodule init
```

### 7.3 更新子模块

**语法：**
```bash
$ git submodule update
```

### 7.4 克隆包含子模块的仓库

**语法：**
```bash
$ git clone --recursive <远程仓库URL>
```

或使用以下步骤：
```bash
$ git clone <远程仓库URL>
$ cd repo
$ git submodule init
$ git submodule update
```

## 8. 高级日志查看

### 8.1 自定义日志格式

**语法：**
```bash
$ git log --pretty=<格式> <选项>
```

**常用格式：**
- `oneline`：简洁格式，每个提交占一行
- `short`：简短格式，显示作者、提交信息
- `full`：完整格式，显示作者、提交者、提交信息
- `fuller`：更完整格式，显示作者、提交者、时间戳、提交信息
- `format:<自定义格式>`：自定义格式

**示例：**
```bash
$ git log --pretty=format:"%h - %an, %ar : %s" -n 5
```

**输出示例：**
```
1a2b3c4 - Your Name, 2 days ago : Add feature A
4g5h6i7 - Your Name, 3 days ago : Add feature B
7j8k9l0 - Your Name, 1 week ago : Update README
0t9s8r7 - Your Name, 2 weeks ago : Initial commit
```

### 8.2 查看文件的提交历史

**语法：**
```bash
$ git log -- <文件路径>
```

**示例：**
```bash
$ git log -- README.md
```

### 8.3 查看指定作者的提交

**语法：**
```bash
$ git log --author=<作者名>
```

**示例：**
```bash
$ git log --author="Your Name"
```

## 9. 高级差异查看

### 9.1 查看两个提交之间的差异

**语法：**
```bash
$ git diff <提交ID1> <提交ID2>
```

**示例：**
```bash
$ git diff 1a2b3c4 4g5h6i7
```

### 9.2 查看两个分支之间的差异

**语法：**
```bash
$ git diff <分支1> <分支2>
```

**示例：**
```bash
$ git diff main feature-branch
```

### 9.3 查看指定文件的差异

**语法：**
```bash
$ git diff <提交ID1> <提交ID2> -- <文件路径>
```

**示例：**
```bash
$ git diff main feature-branch -- README.md
```

## 10. 高级配置

### 10.1 Git 别名

**语法：**
```bash
$ git config --global alias.<别名> <命令>
```

**常用别名示例：**
```bash
$ git config --global alias.st status
$ git config --global alias.ci commit
$ git config --global alias.co checkout
$ git config --global alias.br branch
$ git config --global alias.lg "log --oneline --graph --decorate --all"
$ git config --global alias.df diff
$ git config --global alias.undo "reset HEAD~1 --mixed"
```

### 10.2 Git 钩子

Git 钩子是在特定 Git 事件发生时自动执行的脚本，位于 `.git/hooks` 目录中。

**常用钩子：**
- `pre-commit`：在提交前执行，用于代码检查、格式化等
- `commit-msg`：在提交信息前执行，用于检查提交信息格式
- `pre-push`：在推送前执行，用于运行测试、检查等

**示例：**

创建一个简单的 `pre-commit` 钩子，用于检查代码：

```bash
#!/bin/sh
# 运行 ESLint 检查
npx eslint --ext .js,.ts src/
if [ $? -ne 0 ]; then
  echo "ESLint 检查失败，提交被拒绝"
  exit 1
fi
```

将脚本保存为 `.git/hooks/pre-commit` 并设置可执行权限：
```bash
$ chmod +x .git/hooks/pre-commit
```
