# PowerShell 语法

## 1. 基本语法

### 1.1 命令结构

PowerShell 命令（cmdlet）通常遵循 "动词-名词" 的命名规范，例如：

```powershell
Get-Process
Set-Service
New-Item
Remove-Item
```

### 1.2 参数

命令可以包含参数，参数以 `-` 符号开头，例如：

```powershell
Get-Process -Name "chrome"
New-Item -Path "C:\temp\test.txt" -ItemType "File" -Value "Hello World"
```

### 1.3 管道

管道允许将一个命令的输出作为另一个命令的输入，使用 `|` 符号表示：

```powershell
Get-Process | Where-Object {$_.CPU -gt 100} | Select-Object -Property Name, CPU
```

### 1.4 注释

PowerShell 支持两种注释方式：

1. **单行注释**：使用 `#` 符号
2. **多行注释**：使用 `<#` 和 `#>` 符号

**示例：**
```powershell
# 这是单行注释

<#
这是多行注释
可以包含多行内容
#>
```

## 2. 变量

### 2.1 变量的声明

PowerShell 中的变量以 `$` 符号开头，声明变量时不需要指定数据类型：

```powershell
$name = "John Doe"
$age = 30
$isActive = $true
```

### 2.2 变量的命名规则

- 变量名可以包含字母、数字和下划线
- 变量名不能以数字开头
- 变量名区分大小写
- 变量名最好具有描述性，便于理解

### 2.3 变量的作用域

PowerShell 中的变量有不同的作用域：

- **全局作用域**：在所有脚本和函数中可见，使用 `$global:` 前缀
- **脚本作用域**：在当前脚本中可见，使用 `$script:` 前缀
- **局部作用域**：在当前函数或脚本块中可见，默认作用域
- **私有作用域**：仅在当前作用域中可见，使用 `$private:` 前缀

**示例：**
```powershell
$global:globalVar = "This is a global variable"
$script:scriptVar = "This is a script variable"
$localVar = "This is a local variable"
$private:privateVar = "This is a private variable"
```

### 2.4 自动变量

PowerShell 包含一些自动变量，这些变量由 PowerShell 自动创建和维护：

| 变量名 | 描述 |
|-------|------|
| `$PSVersionTable` | 包含 PowerShell 版本信息 |
| `$PWD` | 包含当前工作目录 |
| `$HOME` | 包含用户的主目录 |
| `$NULL` | 表示空值 |
| `$True` / `$False` | 表示布尔值 |
| `$Error` | 包含最近的错误信息 |
| `$LastExitCode` | 包含上一个外部命令的退出代码 |

## 3. 数据类型

### 3.1 基本数据类型

PowerShell 支持以下基本数据类型：

| 数据类型 | 描述 | 示例 |
|---------|------|------|
| `String` | 字符串 | `"Hello World"` |
| `Int32` / `Int64` | 整数 | `30` |
| `Double` | 浮点数 | `3.14` |
| `Boolean` | 布尔值 | `$true` / `$false` |
| `DateTime` | 日期时间 | `Get-Date` |
| `Array` | 数组 | `@(1, 2, 3)` |
| `Hashtable` | 哈希表 | `@{Name = "John"; Age = 30}` |
| `PSObject` | PowerShell 对象 | `[PSCustomObject]@{Name = "John"; Age = 30}` |

### 3.2 数据类型转换

可以使用类型转换运算符或 `[类型]` 语法进行数据类型转换：

```powershell
# 使用类型转换运算符
$number = "123" -as [int]

# 使用 [类型] 语法
$number = [int]"123"

# 转换为字符串
$string = [string]123

# 转换为布尔值
$bool = [bool]1
```

## 4. 运算符

### 4.1 算术运算符

| 运算符 | 描述 | 示例 |
|-------|------|------|
| `+` | 加法 | `2 + 3` → `5` |
| `-` | 减法 | `5 - 2` → `3` |
| `*` | 乘法 | `2 * 3` → `6` |
| `/` | 除法 | `6 / 2` → `3` |
| `%` | 取余 | `7 % 3` → `1` |
| `++` | 自增 | `$i++` |
| `--` | 自减 | `$i--` |

### 4.2 比较运算符

| 运算符 | 描述 | 示例 |
|-------|------|------|
| `-eq` | 等于 | `1 -eq 1` → `$true` |
| `-ne` | 不等于 | `1 -ne 2` → `$true` |
| `-gt` | 大于 | `3 -gt 2` → `$true` |
| `-ge` | 大于等于 | `2 -ge 2` → `$true` |
| `-lt` | 小于 | `2 -lt 3` → `$true` |
| `-le` | 小于等于 | `2 -le 2` → `$true` |
| `-like` | 通配符匹配 | `"abc" -like "a*"` → `$true` |
| `-notlike` | 不匹配通配符 | `"abc" -notlike "x*"` → `$true` |
| `-match` | 正则表达式匹配 | `"abc" -match "a.*c"` → `$true` |
| `-notmatch` | 不匹配正则表达式 | `"abc" -notmatch "x.*z"` → `$true` |
| `-contains` | 包含 | `@(1, 2, 3) -contains 2` → `$true` |
| `-notcontains` | 不包含 | `@(1, 2, 3) -notcontains 4` → `$true` |
| `-in` | 成员关系 | `2 -in @(1, 2, 3)` → `$true` |
| `-notin` | 非成员关系 | `4 -notin @(1, 2, 3)` → `$true` |

### 4.3 逻辑运算符

| 运算符 | 描述 | 示例 |
|-------|------|------|
| `-and` | 逻辑与 | `$true -and $false` → `$false` |
| `-or` | 逻辑或 | `$true -or $false` → `$true` |
| `-not` | 逻辑非 | `-not $true` → `$false` |
| `!` | 逻辑非（简写） | `!$true` → `$false` |

### 4.4 赋值运算符

| 运算符 | 描述 | 示例 |
|-------|------|------|
| `=` | 赋值 | `$x = 10` |
| `+=` | 加法赋值 | `$x += 5` → `$x = $x + 5` |
| `-=` | 减法赋值 | `$x -= 5` → `$x = $x - 5` |
| `*=` | 乘法赋值 | `$x *= 5` → `$x = $x * 5` |
| `/=` | 除法赋值 | `$x /= 5` → `$x = $x / 5` |
| `%=` | 取余赋值 | `$x %= 5` → `$x = $x % 5` |

## 5. 流程控制

### 5.1 If-Else 语句

**语法：**
```powershell
if (条件) {
    # 条件为真时执行的代码
} elseif (条件) {
    # 条件为真时执行的代码
} else {
    # 所有条件都为假时执行的代码
}
```

**示例：**
```powershell
$age = 18

if ($age -lt 18) {
    Write-Output "未成年"
} elseif ($age -ge 18 -and $age -lt 65) {
    Write-Output "成年人"
} else {
    Write-Output "老年人"
}
```

### 5.2 Switch 语句

**语法：**
```powershell
switch (表达式) {
    值1 {
        # 表达式等于值1时执行的代码
    }
    值2 {
        # 表达式等于值2时执行的代码
    }
    default {
        # 表达式不匹配任何值时执行的代码
    }
}
```

**示例：**
```powershell
$day = "Monday"

switch ($day) {
    "Monday" {
        Write-Output "星期一"
    }
    "Tuesday" {
        Write-Output "星期二"
    }
    default {
        Write-Output "其他星期"
    }
}
```

### 5.3 For 循环

**语法：**
```powershell
for (初始化; 条件; 迭代) {
    # 循环体
}
```

**示例：**
```powershell
for ($i = 0; $i -lt 5; $i++) {
    Write-Output $i
}
```

### 5.4 ForEach 循环

**语法：**
```powershell
foreach (变量 in 集合) {
    # 循环体
}
```

**示例：**
```powershell
$numbers = @(1, 2, 3, 4, 5)

foreach ($num in $numbers) {
    Write-Output $num
}
```

### 5.5 While 循环

**语法：**
```powershell
while (条件) {
    # 循环体
}
```

**示例：**
```powershell
$i = 0

while ($i -lt 5) {
    Write-Output $i
    $i++
}
```

### 5.6 Do-While 循环

**语法：**
```powershell
do {
    # 循环体
} while (条件)
```

**示例：**
```powershell
$i = 0

do {
    Write-Output $i
    $i++
} while ($i -lt 5)
```

### 5.7 Break 和 Continue

- `Break`：退出当前循环
- `Continue`：跳过当前循环的剩余部分，继续下一次循环

**示例：**
```powershell
for ($i = 0; $i -lt 10; $i++) {
    if ($i -eq 5) {
        break  # 退出循环
    }
    if ($i -eq 3) {
        continue  # 跳过当前循环，继续下一次循环
    }
    Write-Output $i
}
```

## 6. 函数

### 6.1 函数的定义

**语法：**
```powershell
function 函数名 {
    # 函数体
}
```

**示例：**
```powershell
function Get-Hello {
    Write-Output "Hello, World!"
}
```

### 6.2 函数的参数

**语法：**
```powershell
function 函数名 {
    param(
        [类型]$参数1,
        [类型]$参数2 = 默认值
    )
    # 函数体
}
```

**示例：**
```powershell
function Get-Greeting {
    param(
        [string]$Name,
        [int]$Age = 18
    )
    Write-Output "Hello, $Name! You are $Age years old."
}
```

### 6.3 函数的调用

**语法：**
```powershell
函数名 -参数1 值1 -参数2 值2
```

**示例：**
```powershell
Get-Greeting -Name "John" -Age 30
```

### 6.4 函数的返回值

PowerShell 函数可以通过 `return` 关键字返回值，也可以直接输出值：

**示例：**
```powershell
function Add-Numbers {
    param(
        [int]$Num1,
        [int]$Num2
    )
    return $Num1 + $Num2
}

$result = Add-Numbers -Num1 2 -Num2 3
Write-Output $result  # 输出 5
```

## 7. 脚本块

脚本块是一段可执行的 PowerShell 代码，用 `{}` 括起来：

**语法：**
```powershell
$脚本块 = {
    # 脚本块内容
}
```

**示例：**
```powershell
$myScriptBlock = {
    param($Name)
    Write-Output "Hello, $Name!"
}

# 执行脚本块
& $myScriptBlock -Name "John"
```

## 8. 模块

### 8.1 导入模块

**语法：**
```powershell
Import-Module 模块名
```

**示例：**
```powershell
Import-Module ActiveDirectory
```

### 8.2 查看已导入的模块

**语法：**
```powershell
Get-Module
```

### 8.3 查看可用的模块

**语法：**
```powershell
Get-Module -ListAvailable
```

## 9. 错误处理

### 9.1 Try-Catch-Finally

**语法：**
```powershell
try {
    # 可能出错的代码
} catch [异常类型] {
    # 处理特定类型的异常
    Write-Output $_.Exception.Message
} catch {
    # 处理所有其他异常
    Write-Output $_.Exception.Message
} finally {
    # 无论是否发生异常都会执行的代码
}
```

**示例：**
```powershell
try {
    Get-Content "C:\nonexistent.txt"
} catch [System.IO.FileNotFoundException] {
    Write-Output "文件不存在：$($_.Exception.Message)"
} catch {
    Write-Output "发生错误：$($_.Exception.Message)"
} finally {
    Write-Output "清理资源"
}
```

### 9.2 错误偏好设置

可以使用 `$ErrorActionPreference` 变量设置 PowerShell 的错误处理行为：

| 值 | 描述 |
|-----|------|
| `Continue` | 继续执行脚本，显示错误信息（默认） |
| `Stop` | 停止执行脚本，显示错误信息 |
| `SilentlyContinue` | 继续执行脚本，不显示错误信息 |
| `Inquire` | 询问用户如何处理错误 |
| `Ignore` | 忽略错误，继续执行脚本 |

**示例：**
```powershell
$ErrorActionPreference = "Stop"
Get-Content "C:\nonexistent.txt"  # 发生错误时停止执行
```

## 10. 总结

PowerShell 语法基于 .NET，结合了命令行和脚本语言的特点。本文介绍了 PowerShell 的基本语法、变量、数据类型、运算符、流程控制语句、函数、脚本块、模块和错误处理等内容。

掌握 PowerShell 语法是使用 PowerShell 进行自动化和配置管理的基础。通过学习和实践，可以逐步掌握 PowerShell 的强大功能，实现复杂的自动化任务。