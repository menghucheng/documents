# AngularJS 控制器

## 1. 控制器概述

控制器是 AngularJS 应用程序的核心组件之一，用于定义应用程序的行为，处理用户交互，连接模型（Model）和视图（View）。

控制器通过作用域（Scope）将数据和方法暴露给视图，视图通过指令（如 `ng-model`、`ng-click`）与控制器交互。

## 2. 定义控制器

### 2.1 基本语法

使用 `angular.module().controller()` 方法定义控制器：

```javascript
var app = angular.module('myApp', []);

app.controller('myCtrl', function($scope) {
  // 控制器逻辑
  $scope.message = "Hello AngularJS";
});
```

### 2.2 控制器命名约定

- 控制器名称使用驼峰命名法，首字母大写
- 控制器名称通常以 "Ctrl" 或 "Controller" 结尾
- 例如：`MainCtrl`、`UserController`、`ProductListCtrl`

## 3. 作用域（Scope）

### 3.1 作用域的概念

作用域是控制器和视图之间的桥梁，它是一个 JavaScript 对象，包含模型数据和方法。

- 控制器通过向作用域添加属性和方法，将数据和行为暴露给视图
- 视图通过指令（如 `{{}}`、`ng-model`）访问作用域中的数据和方法

### 3.2 向作用域添加数据

```javascript
app.controller('myCtrl', function($scope) {
  // 字符串
  $scope.name = "World";
  
  // 数字
  $scope.age = 25;
  
  // 布尔值
  $scope.isActive = true;
  
  // 对象
  $scope.user = {
    name: "John",
    email: "john@example.com"
  };
  
  // 数组
  $scope.items = [
    { id: 1, name: "Item 1" },
    { id: 2, name: "Item 2" },
    { id: 3, name: "Item 3" }
  ];
});
```

### 3.3 向作用域添加方法

```javascript
app.controller('myCtrl', function($scope) {
  $scope.name = "World";
  
  // 定义方法
  $scope.greet = function() {
    return "Hello " + $scope.name;
  };
  
  // 处理表单提交
  $scope.submitForm = function() {
    // 处理表单数据
    console.log($scope.user);
  };
  
  // 处理点击事件
  $scope.handleClick = function(item) {
    console.log("点击了: " + item.name);
  };
});
```

### 3.4 在视图中使用作用域

```html
<div ng-app="myApp" ng-controller="myCtrl">
  <!-- 访问作用域数据 -->
  <h1>{{ message }}</h1>
  <p>姓名: {{ user.name }}</p>
  <p>邮箱: {{ user.email }}</p>
  
  <!-- 调用作用域方法 -->
  <p>{{ greet() }}</p>
  
  <!-- 绑定点击事件 -->
  <button ng-click="handleClick(item)" ng-repeat="item in items">
    {{ item.name }}
  </button>
  
  <!-- 绑定表单提交 -->
  <form ng-submit="submitForm()">
    <input type="text" ng-model="user.name">
    <input type="email" ng-model="user.email">
    <button type="submit">提交</button>
  </form>
</div>
```

## 4. 依赖注入

### 4.1 基本概念

AngularJS 的依赖注入（Dependency Injection）机制允许开发者将依赖项注入到控制器中，而不是在控制器内部创建它们。

### 4.2 注入内置服务

```javascript
app.controller('myCtrl', function($scope, $http, $timeout, $location) {
  // 使用 $http 服务发送请求
  $http.get('/api/data').then(function(response) {
    $scope.data = response.data;
  });
  
  // 使用 $timeout 服务延迟执行
  $timeout(function() {
    $scope.message = "延迟加载的消息";
  }, 2000);
  
  // 使用 $location 服务获取当前 URL
  $scope.currentUrl = $location.absUrl();
});
```

### 4.3 注入自定义服务

```javascript
// 定义自定义服务
app.service('dataService', function() {
  this.getData = function() {
    return [/* 数据 */];
  };
});

// 在控制器中注入自定义服务
app.controller('myCtrl', function($scope, dataService) {
  $scope.data = dataService.getData();
});
```

### 4.4 安全的依赖注入（避免代码压缩问题）

当代码被压缩时，参数名称会被替换，导致依赖注入失败。可以使用以下方式避免：

#### 4.4.1 数组语法

```javascript
app.controller('myCtrl', ['$scope', '$http', 'dataService', function($scope, $http, dataService) {
  // 控制器逻辑
}]);
```

#### 4.4.2 $inject 属性

```javascript
function MyController($scope, $http, dataService) {
  // 控制器逻辑
}

MyController.$inject = ['$scope', '$http', 'dataService'];
app.controller('myCtrl', MyController);
```

## 5. 控制器继承

### 5.1 作用域继承

AngularJS 的作用域是有层次结构的，子作用域继承父作用域的属性和方法。

```html
<div ng-controller="parentCtrl">
  <h1>父控制器: {{ message }}</h1>
  
  <div ng-controller="childCtrl">
    <h2>子控制器: {{ message }}</h2>
    <p>继承的属性: {{ parentProperty }}</p>
  </div>
</div>
```

```javascript
app.controller('parentCtrl', function($scope) {
  $scope.message = "父控制器消息";
  $scope.parentProperty = "这是父控制器的属性";
});

app.controller('childCtrl', function($scope) {
  // 覆盖父控制器的属性
  $scope.message = "子控制器消息";
});
```

### 5.2 事件传播

作用域之间可以通过事件进行通信：

- `$emit`：向上传播事件到父作用域
- `$broadcast`：向下传播事件到子作用域
- `$on`：监听事件

```javascript
app.controller('parentCtrl', function($scope) {
  // 监听子作用域发送的事件
  $scope.$on('childEvent', function(event, data) {
    console.log('收到子作用域事件:', data);
  });
  
  // 向子作用域广播事件
  $scope.$broadcast('parentEvent', '来自父作用域的消息');
});

app.controller('childCtrl', function($scope) {
  // 监听父作用域广播的事件
  $scope.$on('parentEvent', function(event, data) {
    console.log('收到父作用域事件:', data);
  });
  
  // 向父作用域发送事件
  $scope.sendEvent = function() {
    $scope.$emit('childEvent', '来自子作用域的消息');
  };
});
```

## 6. 控制器生命周期

### 6.1 初始化阶段

1. 创建控制器实例
2. 注入依赖项
3. 执行控制器函数，初始化作用域
4. 将控制器与视图关联

### 6.2 $onInit 钩子

在 AngularJS 1.5+ 中，可以使用 `$onInit` 钩子在控制器初始化完成后执行代码：

```javascript
app.controller('myCtrl', function() {
  var vm = this;
  
  vm.$onInit = function() {
    // 初始化代码
    vm.message = "控制器初始化完成";
  };
});
```

### 6.3 $onDestroy 钩子

使用 `$onDestroy` 钩子在控制器销毁前执行清理代码：

```javascript
app.controller('myCtrl', function($scope, $interval) {
  var interval = $interval(function() {
    // 定期执行的代码
  }, 1000);
  
  $scope.$on('$destroy', function() {
    // 清理资源
    $interval.cancel(interval);
  });
});
```

## 7. 控制器的最佳实践

### 7.1 不要在控制器中操作 DOM

控制器应该只负责业务逻辑和数据处理，DOM 操作应该通过指令或服务完成。

**不好的做法：**
```javascript
app.controller('myCtrl', function($scope) {
  // 避免在控制器中操作 DOM
  document.getElementById('myElement').style.color = 'red';
});
```

**好的做法：**
```javascript
// 使用指令操作 DOM
app.directive('myDirective', function() {
  return {
    link: function(scope, element) {
      element.css('color', 'red');
    }
  };
});
```

### 7.2 不要在控制器中进行数据格式化

数据格式化应该通过过滤器完成。

**不好的做法：**
```javascript
app.controller('myCtrl', function($scope) {
  $scope.formatDate = function(date) {
    // 格式化日期的代码
    return formattedDate;
  };
});
```

**好的做法：**
```javascript
// 使用过滤器格式化数据
app.filter('dateFormat', function() {
  return function(date) {
    // 格式化日期的代码
    return formattedDate;
  };
});
```

### 7.3 不要在控制器中实例化服务

服务应该通过依赖注入注入到控制器中，而不是在控制器内部实例化。

**不好的做法：**
```javascript
app.controller('myCtrl', function($scope) {
  // 避免在控制器中实例化服务
  var dataService = new DataService();
  $scope.data = dataService.getData();
});
```

**好的做法：**
```javascript
// 通过依赖注入使用服务
app.controller('myCtrl', function($scope, dataService) {
  $scope.data = dataService.getData();
});
```

### 7.4 使用 Controller As 语法

Controller As 语法允许开发者使用别名引用控制器，避免使用 `$scope`，使代码更清晰。

```javascript
app.controller('myCtrl', function() {
  var vm = this;
  vm.message = "Hello AngularJS";
  
  vm.greet = function() {
    return "Hello " + vm.name;
  };
});
```

```html
<div ng-controller="myCtrl as vm">
  <h1>{{ vm.message }}</h1>
  <input type="text" ng-model="vm.name">
  <p>{{ vm.greet() }}</p>
</div>
```

### 7.5 保持控制器简洁

控制器应该只包含与视图相关的逻辑，复杂的业务逻辑应该封装到服务中。

**不好的做法：**
```javascript
app.controller('myCtrl', function($scope, $http) {
  // 复杂的业务逻辑
  $scope.processData = function() {
    // 大量的业务逻辑代码
  };
  
  // 数据获取逻辑
  $http.get('/api/data').then(function(response) {
    // 数据处理逻辑
    $scope.processData();
  });
});
```

**好的做法：**
```javascript
// 将业务逻辑封装到服务中
app.service('dataService', function($http) {
  this.getData = function() {
    return $http.get('/api/data').then(function(response) {
      // 数据处理逻辑
      return processedData;
    });
  };
});

// 控制器只负责视图逻辑
app.controller('myCtrl', function($scope, dataService) {
  dataService.getData().then(function(data) {
    $scope.data = data;
  });
});
```

## 8. 控制器与组件的比较

在 AngularJS 1.5+ 中，引入了组件（Component）概念，它是基于指令的简化版本，更接近 Angular 2+ 的组件模型。

| 特性 | 控制器 | 组件 |
|------|--------|------|
| 语法 | `app.controller()` | `app.component()` |
| 作用域 | 可以是原型继承或隔离作用域 | 总是隔离作用域 |
| 模板 | 需要在 HTML 中指定 | 可以在组件定义中指定 |
| 控制器 | 需要显式定义 | 可以在组件内部定义 |
| 绑定 | 使用 `$scope` 或 `Controller As` | 使用 `bindings` 属性 |
| 生命周期钩子 | 有限的钩子 | 完整的生命周期钩子 |
| 推荐使用 | 传统方式 | 现代方式，接近 Angular 2+ |

## 9. 总结

控制器是 AngularJS 应用程序的核心组件之一，用于连接模型和视图，处理用户交互。通过依赖注入机制，可以将各种服务注入到控制器中，提高代码的可测试性和可维护性。

遵循控制器的最佳实践，如避免 DOM 操作、使用 Controller As 语法、保持控制器简洁等，可以提高代码的质量和可维护性。

虽然组件（Component）是 AngularJS 1.5+ 中推荐的方式，但控制器仍然是许多现有应用的基础，掌握控制器的使用对于维护和开发 AngularJS 应用至关重要。