# AngularJS 表单与验证

## 1. 概述

AngularJS 提供了强大的表单处理和验证功能，通过内置的指令和服务，可以轻松实现复杂的表单验证逻辑。本文档将介绍 AngularJS 表单的基本概念、内置验证指令、自定义验证、表单状态管理和最佳实践。

## 2. 表单基础

### 2.1 基本表单结构

AngularJS 表单使用 `ng-form` 或 `<form>` 标签创建，结合 `ng-model` 指令将表单控件与模型数据绑定。

```html
<!DOCTYPE html>
<html ng-app="myApp">
<head>
    <title>AngularJS 表单验证</title>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
</head>
<body ng-controller="FormController">
    <h2>简单表单示例</h2>
    
    <form name="myForm" novalidate>
        <div>
            <label for="name">姓名：</label>
            <input type="text" id="name" name="name" ng-model="formData.name" required>
        </div>
        
        <div>
            <label for="email">邮箱：</label>
            <input type="email" id="email" name="email" ng-model="formData.email" required>
        </div>
        
        <div>
            <label for="age">年龄：</label>
            <input type="number" id="age" name="age" ng-model="formData.age" min="18" max="100">
        </div>
        
        <div>
            <button type="submit" ng-disabled="myForm.$invalid">提交</button>
        </div>
    </form>
    
    <h3>表单数据：</h3>
    <pre>{{ formData | json }}</pre>
    
    <h3>表单状态：</h3>
    <pre>{{ myForm.$valid | json }}</pre>
</body>
</html>

<script>
angular.module('myApp', [])
.controller('FormController', function($scope) {
    $scope.formData = {
        name: '',
        email: '',
        age: ''
    };
});
</script>
```

### 2.2 ng-model 双向绑定

`ng-model` 指令实现了表单控件与数据模型的双向绑定：
- 当用户修改表单控件的值时，数据模型会自动更新
- 当数据模型的值发生变化时，表单控件会自动更新

### 2.3 novalidate 属性

`novalidate` 属性用于禁用浏览器默认的 HTML5 验证，让 AngularJS 完全控制表单验证。

## 3. 内置验证指令

AngularJS 提供了一系列内置的验证指令，可以直接应用于表单控件：

### 3.1 必填项验证

```html
<input type="text" ng-model="name" required>
```

### 3.2 邮箱验证

```html
<input type="email" ng-model="email">
```

### 3.3 数字验证

```html
<input type="number" ng-model="age">
```

### 3.4 URL 验证

```html
<input type="url" ng-model="website">
```

### 3.5 日期验证

```html
<input type="date" ng-model="birthdate">
```

### 3.6 最小值验证

```html
<input type="number" ng-model="age" min="18">
```

### 3.7 最大值验证

```html
<input type="number" ng-model="age" max="100">
```

### 3.8 长度验证

```html
<input type="text" ng-model="password" ng-minlength="6" ng-maxlength="20">
```

### 3.9 正则表达式验证

```html
<input type="text" ng-model="phone" ng-pattern="/^[0-9]{11}$/">
```

## 4. 表单和控件状态

AngularJS 为表单和控件提供了一系列状态属性，可以用于检查验证状态：

### 4.1 表单状态属性

| 属性 | 描述 |
|------|------|
| `$valid` | 表单所有控件都通过验证时为 true |
| `$invalid` | 表单中有任何控件未通过验证时为 true |
| `$pristine` | 表单未被用户修改过时为 true |
| `$dirty` | 表单被用户修改过时为 true |
| `$submitted` | 表单被提交过时为 true |

### 4.2 控件状态属性

| 属性 | 描述 |
|------|------|
| `$valid` | 控件通过验证时为 true |
| `$invalid` | 控件未通过验证时为 true |
| `$pristine` | 控件未被用户修改过时为 true |
| `$dirty` | 控件被用户修改过时为 true |
| `$touched` | 控件被用户触摸过时为 true |
| `$untouched` | 控件未被用户触摸过时为 true |
| `$error` | 包含控件的错误信息 |

### 4.3 检查表单状态

```html
<form name="myForm">
    <input type="text" name="email" ng-model="email" required email>
    
    <p ng-if="myForm.email.$error.required && myForm.email.$touched">邮箱是必填项</p>
    <p ng-if="myForm.email.$error.email && myForm.email.$touched">请输入有效的邮箱地址</p>
    
    <button type="submit" ng-disabled="myForm.$invalid">提交</button>
</form>
```

## 5. 验证错误信息

### 5.1 基本错误信息显示

使用 `ng-if` 或 `ng-show` 指令根据控件的错误状态显示相应的错误信息：

```html
<form name="registrationForm">
    <div>
        <label for="username">用户名：</label>
        <input type="text" id="username" name="username" ng-model="user.username" required ng-minlength="3" ng-maxlength="20">
        <p class="error" ng-if="registrationForm.username.$error.required && registrationForm.username.$touched">用户名是必填项</p>
        <p class="error" ng-if="registrationForm.username.$error.minlength && registrationForm.username.$touched">用户名长度不能少于3个字符</p>
        <p class="error" ng-if="registrationForm.username.$error.maxlength && registrationForm.username.$touched">用户名长度不能超过20个字符</p>
    </div>
    
    <div>
        <label for="email">邮箱：</label>
        <input type="email" id="email" name="email" ng-model="user.email" required email>
        <p class="error" ng-if="registrationForm.email.$error.required && registrationForm.email.$touched">邮箱是必填项</p>
        <p class="error" ng-if="registrationForm.email.$error.email && registrationForm.email.$touched">请输入有效的邮箱地址</p>
    </div>
    
    <div>
        <label for="password">密码：</label>
        <input type="password" id="password" name="password" ng-model="user.password" required ng-minlength="6">
        <p class="error" ng-if="registrationForm.password.$error.required && registrationForm.password.$touched">密码是必填项</p>
        <p class="error" ng-if="registrationForm.password.$error.minlength && registrationForm.password.$touched">密码长度不能少于6个字符</p>
    </div>
    
    <div>
        <label for="confirmPassword">确认密码：</label>
        <input type="password" id="confirmPassword" name="confirmPassword" ng-model="user.confirmPassword" required ng-match="user.password">
        <p class="error" ng-if="registrationForm.confirmPassword.$error.required && registrationForm.confirmPassword.$touched">请确认密码</p>
        <p class="error" ng-if="registrationForm.confirmPassword.$error.match && registrationForm.confirmPassword.$touched">两次输入的密码不一致</p>
    </div>
    
    <button type="submit" ng-disabled="registrationForm.$invalid">注册</button>
</form>
```

### 5.2 自定义验证指令

创建一个自定义验证指令来实现密码匹配验证：

```javascript
angular.module('myApp', [])
.directive('ngMatch', function() {
    return {
        require: 'ngModel',
        scope: {
            ngMatch: '='
        },
        link: function(scope, element, attrs, ctrl) {
            scope.$watch(function() {
                return (ctrl.$pristine && angular.isUndefined(ctrl.$modelValue)) || scope.ngMatch === ctrl.$modelValue;
            }, function(isValid) {
                ctrl.$setValidity('match', isValid);
            });
        }
    };
});
```

## 6. 自定义验证

### 6.1 创建自定义验证指令

除了内置验证指令外，AngularJS 允许创建自定义验证指令来满足特定的业务需求。

```javascript
// 自定义验证指令：验证手机号码
angular.module('myApp', [])
.directive('phoneNumber', function() {
    return {
        require: 'ngModel',
        link: function(scope, element, attrs, ctrl) {
            var phoneRegex = /^1[3-9]\d{9}$/;
            
            ctrl.$validators.phoneNumber = function(modelValue, viewValue) {
                if (ctrl.$isEmpty(modelValue)) {
                    // 空值视为有效（如果需要必填，使用 required 指令）
                    return true;
                }
                
                if (phoneRegex.test(viewValue)) {
                    // 验证通过
                    return true;
                }
                
                // 验证失败
                return false;
            };
        }
    };
});
```

### 6.2 使用自定义验证指令

```html
<input type="text" name="phone" ng-model="phone" phone-number>
<p ng-if="myForm.phone.$error.phoneNumber && myForm.phone.$touched">请输入有效的手机号码</p>
```

### 6.3 异步验证

对于需要服务器验证的情况，AngularJS 支持异步验证：

```javascript
// 自定义异步验证指令：验证用户名是否已存在
angular.module('myApp', [])
.directive('uniqueUsername', function($http, $q) {
    return {
        require: 'ngModel',
        link: function(scope, element, attrs, ctrl) {
            ctrl.$asyncValidators.uniqueUsername = function(modelValue, viewValue) {
                if (ctrl.$isEmpty(modelValue)) {
                    // 空值视为有效
                    return $q.when();
                }
                
                var def = $q.defer();
                
                // 模拟服务器请求
                $http.get('/api/check-username?username=' + viewValue)
                    .then(function(response) {
                        if (response.data.isAvailable) {
                            def.resolve(); // 验证通过
                        } else {
                            def.reject(); // 验证失败
                        }
                    })
                    .catch(function() {
                        def.reject(); // 服务器错误，验证失败
                    });
                
                return def.promise;
            };
        }
    };
});
```

## 7. 表单提交处理

### 7.1 基本表单提交

使用 `ng-submit` 指令处理表单提交：

```html
<form name="myForm" ng-submit="submitForm()" novalidate>
    <!-- 表单控件 -->
    <button type="submit" ng-disabled="myForm.$invalid">提交</button>
</form>
```

```javascript
angular.module('myApp', [])
.controller('FormController', function($scope) {
    $scope.formData = {};
    
    $scope.submitForm = function() {
        if ($scope.myForm.$valid) {
            // 表单验证通过，处理提交逻辑
            console.log('表单提交：', $scope.formData);
            // 可以在这里发送 AJAX 请求
        }
    };
});
```

### 7.2 重置表单

使用 `$setPristine()` 和 `$setUntouched()` 方法重置表单状态：

```html
<button type="button" ng-click="resetForm()">重置</button>
```

```javascript
$scope.resetForm = function() {
    $scope.formData = {};
    $scope.myForm.$setPristine();
    $scope.myForm.$setUntouched();
};
```

### 7.3 表单提交状态管理

处理表单提交中的加载状态：

```html
<form name="myForm" ng-submit="submitForm()" novalidate>
    <!-- 表单控件 -->
    <button type="submit" ng-disabled="myForm.$invalid || isSubmitting">
        <span ng-if="isSubmitting">提交中...</span>
        <span ng-if="!isSubmitting">提交</span>
    </button>
</form>
```

```javascript
$scope.isSubmitting = false;

$scope.submitForm = function() {
    if ($scope.myForm.$valid) {
        $scope.isSubmitting = true;
        
        // 模拟异步请求
        setTimeout(function() {
            console.log('表单提交：', $scope.formData);
            $scope.isSubmitting = false;
            $scope.$apply(); // 手动触发脏检查
        }, 1500);
    }
};
```

## 8. 表单分组与嵌套表单

对于复杂表单，可以使用 `ng-form` 指令创建嵌套表单，实现表单分组和独立验证：

```html
<form name="parentForm" novalidate>
    <h3>个人信息</h3>
    <ng-form name="personalForm">
        <div>
            <label for="name">姓名：</label>
            <input type="text" id="name" name="name" ng-model="user.name" required>
            <p ng-if="personalForm.name.$error.required && personalForm.name.$touched">姓名是必填项</p>
        </div>
        
        <div>
            <label for="email">邮箱：</label>
            <input type="email" id="email" name="email" ng-model="user.email" required email>
            <p ng-if="personalForm.email.$error.required && personalForm.email.$touched">邮箱是必填项</p>
            <p ng-if="personalForm.email.$error.email && personalForm.email.$touched">请输入有效的邮箱地址</p>
        </div>
    </ng-form>
    
    <h3>地址信息</h3>
    <ng-form name="addressForm">
        <div>
            <label for="street">街道：</label>
            <input type="text" id="street" name="street" ng-model="user.street" required>
            <p ng-if="addressForm.street.$error.required && addressForm.street.$touched">街道是必填项</p>
        </div>
        
        <div>
            <label for="city">城市：</label>
            <input type="text" id="city" name="city" ng-model="user.city" required>
            <p ng-if="addressForm.city.$error.required && addressForm.city.$touched">城市是必填项</p>
        </div>
    </ng-form>
    
    <button type="submit" ng-disabled="parentForm.$invalid">提交</button>
</form>
```

## 9. 表单验证的最佳实践

### 9.1 即时反馈

- 只在用户触摸或修改控件后显示错误信息
- 使用 `$touched` 或 `$dirty` 状态来控制错误信息的显示

### 9.2 清晰的错误信息

- 错误信息应该清晰、具体，告诉用户需要做什么来修复
- 使用简洁的语言，避免技术术语

### 9.3 视觉反馈

- 使用 CSS 样式突出显示无效的控件
- 为有效的控件提供视觉确认

```css
/* 无效控件样式 */
input.ng-invalid.ng-touched {
    border-color: #dc3545;
}

/* 有效控件样式 */
input.ng-valid.ng-dirty {
    border-color: #28a745;
}

/* 错误信息样式 */
.error {
    color: #dc3545;
    font-size: 12px;
    margin-top: 4px;
}
```

### 9.4 服务器验证集成

- 处理服务器返回的验证错误
- 显示服务器端的错误信息

```javascript
$scope.submitForm = function() {
    if ($scope.myForm.$valid) {
        $http.post('/api/submit-form', $scope.formData)
            .then(function(response) {
                // 处理成功响应
            })
            .catch(function(error) {
                if (error.data.errors) {
                    // 处理服务器返回的验证错误
                    $scope.serverErrors = error.data.errors;
                }
            });
    }
};
```

### 9.5 性能优化

- 避免在模板中使用复杂的表达式
- 使用 `track by` 指令优化 ng-repeat 性能
- 考虑使用单向绑定（`::`）减少监听

## 10. 实例：完整的注册表单

```html
<!DOCTYPE html>
<html ng-app="registrationApp">
<head>
    <title>AngularJS 注册表单</title>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <style>
        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        input.ng-invalid.ng-touched {
            border-color: #dc3545;
        }
        input.ng-valid.ng-dirty {
            border-color: #28a745;
        }
        .error {
            color: #dc3545;
            font-size: 12px;
            margin-top: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .success-message {
            color: #28a745;
            margin-top: 15px;
            padding: 10px;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container" ng-controller="RegistrationController">
        <h2>用户注册</h2>
        
        <div class="success-message" ng-if="registrationSuccess">
            注册成功！欢迎加入我们！
        </div>
        
        <form name="registrationForm" ng-submit="submitRegistration()" novalidate>
            <div class="form-group">
                <label for="username">用户名</label>
                <input type="text" id="username" name="username" ng-model="user.username" required ng-minlength="3" ng-maxlength="20" unique-username>
                <p class="error" ng-if="registrationForm.username.$error.required && registrationForm.username.$touched">用户名是必填项</p>
                <p class="error" ng-if="registrationForm.username.$error.minlength && registrationForm.username.$touched">用户名长度不能少于3个字符</p>
                <p class="error" ng-if="registrationForm.username.$error.maxlength && registrationForm.username.$touched">用户名长度不能超过20个字符</p>
                <p class="error" ng-if="registrationForm.username.$error.uniqueUsername && registrationForm.username.$touched">该用户名已被使用</p>
            </div>
            
            <div class="form-group">
                <label for="email">邮箱</label>
                <input type="email" id="email" name="email" ng-model="user.email" required email>
                <p class="error" ng-if="registrationForm.email.$error.required && registrationForm.email.$touched">邮箱是必填项</p>
                <p class="error" ng-if="registrationForm.email.$error.email && registrationForm.email.$touched">请输入有效的邮箱地址</p>
            </div>
            
            <div class="form-group">
                <label for="phone">手机号码</label>
                <input type="text" id="phone" name="phone" ng-model="user.phone" required phone-number>
                <p class="error" ng-if="registrationForm.phone.$error.required && registrationForm.phone.$touched">手机号码是必填项</p>
                <p class="error" ng-if="registrationForm.phone.$error.phoneNumber && registrationForm.phone.$touched">请输入有效的手机号码</p>
            </div>
            
            <div class="form-group">
                <label for="password">密码</label>
                <input type="password" id="password" name="password" ng-model="user.password" required ng-minlength="6">
                <p class="error" ng-if="registrationForm.password.$error.required && registrationForm.password.$touched">密码是必填项</p>
                <p class="error" ng-if="registrationForm.password.$error.minlength && registrationForm.password.$touched">密码长度不能少于6个字符</p>
            </div>
            
            <div class="form-group">
                <label for="confirmPassword">确认密码</label>
                <input type="password" id="confirmPassword" name="confirmPassword" ng-model="user.confirmPassword" required ng-match="user.password">
                <p class="error" ng-if="registrationForm.confirmPassword.$error.required && registrationForm.confirmPassword.$touched">请确认密码</p>
                <p class="error" ng-if="registrationForm.confirmPassword.$error.match && registrationForm.confirmPassword.$touched">两次输入的密码不一致</p>
            </div>
            
            <div class="form-group">
                <label for="birthdate">出生日期</label>
                <input type="date" id="birthdate" name="birthdate" ng-model="user.birthdate" required>
                <p class="error" ng-if="registrationForm.birthdate.$error.required && registrationForm.birthdate.$touched">出生日期是必填项</p>
            </div>
            
            <div class="form-group">
                <button type="submit" ng-disabled="registrationForm.$invalid || isSubmitting">
                    <span ng-if="isSubmitting">注册中...</span>
                    <span ng-if="!isSubmitting">注册</span>
                </button>
                <button type="button" ng-click="resetForm()" style="margin-left: 10px;">重置</button>
            </div>
        </form>
        
        <h3>表单状态</h3>
        <pre>表单有效：{{ registrationForm.$valid }}</pre>
        <pre>表单提交：{{ registrationForm.$submitted }}</pre>
        <pre>表单数据：{{ user | json }}</pre>
    </div>
</body>
</html>

<script>
// 创建 AngularJS 应用
angular.module('registrationApp', [])

// 自定义验证指令：匹配密码
.directive('ngMatch', function() {
    return {
        require: 'ngModel',
        scope: {
            ngMatch: '='
        },
        link: function(scope, element, attrs, ctrl) {
            scope.$watch(function() {
                return (ctrl.$pristine && angular.isUndefined(ctrl.$modelValue)) || scope.ngMatch === ctrl.$modelValue;
            }, function(isValid) {
                ctrl.$setValidity('match', isValid);
            });
        }
    };
})

// 自定义验证指令：验证手机号码
.directive('phoneNumber', function() {
    return {
        require: 'ngModel',
        link: function(scope, element, attrs, ctrl) {
            var phoneRegex = /^1[3-9]\d{9}$/;
            
            ctrl.$validators.phoneNumber = function(modelValue, viewValue) {
                if (ctrl.$isEmpty(modelValue)) {
                    return true;
                }
                
                if (phoneRegex.test(viewValue)) {
                    return true;
                }
                
                return false;
            };
        }
    };
})

// 自定义异步验证指令：验证用户名是否已存在
.directive('uniqueUsername', function($q, $timeout) {
    return {
        require: 'ngModel',
        link: function(scope, element, attrs, ctrl) {
            ctrl.$asyncValidators.uniqueUsername = function(modelValue, viewValue) {
                if (ctrl.$isEmpty(modelValue)) {
                    return $q.when();
                }
                
                var def = $q.defer();
                
                // 模拟服务器请求，延迟 500ms
                $timeout(function() {
                    // 模拟用户名 "admin" 已被使用
                    if (viewValue === 'admin') {
                        def.reject();
                    } else {
                        def.resolve();
                    }
                }, 500);
                
                return def.promise;
            };
        }
    };
})

// 控制器
.controller('RegistrationController', function($scope, $timeout) {
    // 初始化用户数据
    $scope.user = {
        username: '',
        email: '',
        phone: '',
        password: '',
        confirmPassword: '',
        birthdate: ''
    };
    
    $scope.isSubmitting = false;
    $scope.registrationSuccess = false;
    
    // 提交注册
    $scope.submitRegistration = function() {
        if ($scope.registrationForm.$valid) {
            $scope.isSubmitting = true;
            
            // 模拟注册请求
            $timeout(function() {
                console.log('注册数据：', $scope.user);
                $scope.isSubmitting = false;
                $scope.registrationSuccess = true;
                $scope.resetForm();
            }, 1500);
        }
    };
    
    // 重置表单
    $scope.resetForm = function() {
        $scope.user = {
            username: '',
            email: '',
            phone: '',
            password: '',
            confirmPassword: '',
            birthdate: ''
        };
        
        if ($scope.registrationForm) {
            $scope.registrationForm.$setPristine();
            $scope.registrationForm.$setUntouched();
        }
        
        $scope.registrationSuccess = false;
    };
});
</script>
```

## 11. 总结

AngularJS 提供了强大的表单处理和验证功能，通过内置的指令和服务，可以轻松实现复杂的表单验证逻辑。本文档介绍了 AngularJS 表单的基本概念、内置验证指令、自定义验证、表单状态管理和最佳实践。

主要内容包括：

1. 表单基础：`ng-model` 双向绑定、表单结构
2. 内置验证指令：required、email、number、url、min、max、ng-minlength、ng-maxlength、ng-pattern
3. 表单和控件状态：$valid、$invalid、$pristine、$dirty、$touched、$error
4. 自定义验证：创建自定义验证指令、异步验证
5. 表单提交处理：ng-submit、重置表单、处理提交状态
6. 表单分组与嵌套表单
7. 最佳实践：即时反馈、清晰的错误信息、视觉反馈、服务器验证集成
8. 完整实例：用户注册表单

通过掌握这些知识，你可以构建出功能完整、用户体验良好的 AngularJS 表单应用。虽然 AngularJS 已经是一个比较旧的框架，但它的表单验证机制仍然具有学习价值，特别是对于理解前端表单验证的基本概念和原理非常有帮助。