# Next.js 路由

## 1. 路由概述

Next.js 使用基于文件系统的路由机制，无需额外配置路由表。页面文件存放在 `pages/` 目录下，每个文件对应一个路由。

## 2. 基础路由

### 2.1 静态路由

静态路由是最基本的路由类型，直接映射文件路径到 URL。

| 文件路径 | URL 路径 |
|---------|---------|
| `pages/index.js` | `/` |
| `pages/about.js` | `/about` |
| `pages/blog/index.js` | `/blog` |
| `pages/blog/post.js` | `/blog/post` |

### 2.2 动态路由

动态路由允许在 URL 中使用参数，使用方括号 `[]` 表示动态参数。

| 文件路径 | URL 路径 | 参数 |
|---------|---------|------|
| `pages/blog/[id].js` | `/blog/1` | `{ id: '1' }` |
| `pages/products/[slug].js` | `/products/next-js-book` | `{ slug: 'next-js-book' }` |
| `pages/posts/[...slug].js` | `/posts/2023/01/01` | `{ slug: ['2023', '01', '01'] }` |

### 2.3 嵌套动态路由

可以组合多个动态参数创建更复杂的路由结构。

| 文件路径 | URL 路径 | 参数 |
|---------|---------|------|
| `pages/blog/[category]/[id].js` | `/blog/technology/1` | `{ category: 'technology', id: '1' }` |

## 3. 访问路由参数

使用 `useRouter` Hook 或 `getServerSideProps`/`getStaticProps` 函数访问路由参数。

### 3.1 使用 useRouter Hook

```jsx
import { useRouter } from 'next/router';

function Post() {
  const router = useRouter();
  const { id } = router.query;

  return <div>文章 ID: {id}</div>;
}

export default Post;
```

### 3.2 在数据获取函数中访问参数

```jsx
export async function getServerSideProps(context) {
  const { id } = context.params;
  // 获取数据
  return {
    props: { id }
  };
}

function Post({ id }) {
  return <div>文章 ID: {id}</div>;
}

export default Post;
```

## 4. 路由导航

### 4.1 使用 Link 组件

`next/link` 组件用于客户端导航，避免页面刷新，提高用户体验。

```jsx
import Link from 'next/link';

function Navbar() {
  return (
    <nav>
      <Link href="/">首页</Link>
      <Link href="/about">关于我们</Link>
      <Link href="/blog/1">文章 1</Link>
    </nav>
  );
}
```

### 4.2 使用 router.push()

在事件处理函数或条件渲染中，可以使用 `router.push()` 进行编程式导航。

```jsx
import { useRouter } from 'next/router';

function Navigation() {
  const router = useRouter();

  const handleClick = () => {
    router.push('/about');
  };

  return (
    <div>
      <button onClick={handleClick}>前往关于页面</button>
    </div>
  );
}
```

### 4.3 带参数的导航

```jsx
// 字符串形式
router.push('/blog/[id]', '/blog/1');

// 对象形式
router.push({
  pathname: '/blog/[id]',
  query: { id: 1 }
});
```

## 5. 路由预加载

Next.js 自动预加载视口中的 `Link` 组件指向的页面，提高导航速度。也可以手动控制预加载行为。

### 5.1 禁用预加载

```jsx
<Link href="/about" prefetch={false}>关于我们</Link>
```

### 5.2 手动预加载

```jsx
import { useRouter } from 'next/router';

function Navigation() {
  const router = useRouter();

  const preloadPage = () => {
    router.prefetch('/about');
  };

  return (
    <div>
      <button onMouseEnter={preloadPage}>悬停时预加载关于页面</button>
      <Link href="/about">关于我们</Link>
    </div>
  );
}
```

## 6. 路由事件

Next.js 提供了路由事件，可以监听路由变化过程中的不同阶段。

```jsx
import { useRouter } from 'next/router';
import { useEffect } from 'react';

function App() {
  const router = useRouter();

  useEffect(() => {
    const handleStart = (url) => {
      console.log(`开始导航到: ${url}`);
    };

    const handleComplete = (url) => {
      console.log(`导航完成到: ${url}`);
    };

    const handleError = (err, url) => {
      console.error(`导航到 ${url} 失败:`, err);
    };

    router.events.on('routeChangeStart', handleStart);
    router.events.on('routeChangeComplete', handleComplete);
    router.events.on('routeChangeError', handleError);

    return () => {
      router.events.off('routeChangeStart', handleStart);
      router.events.off('routeChangeComplete', handleComplete);
      router.events.off('routeChangeError', handleError);
    };
  }, []);

  return <div>应用内容</div>;
}
```

## 7. 嵌套路由与布局

### 7.1 使用 _app.js 创建全局布局

`_app.js` 是应用的根组件，可以用于创建全局布局、添加全局样式等。

```jsx
// pages/_app.js
import '../styles/globals.css';

function MyApp({ Component, pageProps }) {
  return (
    <div className="app-container">
      <header>
        <nav>
          <Link href="/">首页</Link>
          <Link href="/about">关于我们</Link>
        </nav>
      </header>
      <main>
        <Component {...pageProps} />
      </main>
      <footer>
        <p>© 2025 Next.js 示例应用</p>
      </footer>
    </div>
  );
}

export default MyApp;
```

### 7.2 自定义布局组件

可以创建自定义布局组件，为不同页面应用不同的布局。

```jsx
// components/Layout.js
import Link from 'next/link';

function Layout({ children }) {
  return (
    <div className="layout">
      <header>
        <h1>我的博客</h1>
        <nav>
          <Link href="/">首页</Link>
          <Link href="/blog">博客</Link>
          <Link href="/about">关于</Link>
        </nav>
      </header>
      <main>{children}</main>
      <footer>© 2025 我的博客</footer>
    </div>
  );
}

export default Layout;

// pages/blog/index.js
import Layout from '../../components/Layout';

function Blog() {
  return (
    <Layout>
      <h2>博客列表</h2>
      {/* 博客内容 */}
    </Layout>
  );
}

export default Blog;
```

## 8. API 路由

API 路由存放在 `pages/api/` 目录下，用于创建后端 API 端点。

```jsx
// pages/api/hello.js
export default function handler(req, res) {
  res.status(200).json({ name: 'John Doe' });
}
```

访问 URL: `http://localhost:3000/api/hello`

## 9. 高级路由功能

### 9.1 可选的捕获所有路由

使用 `[[...slug]]` 表示可选的捕获所有路由，允许 URL 不包含该参数。

| 文件路径 | URL 路径 | 参数 |
|---------|---------|------|
| `pages/posts/[[...slug]].js` | `/posts` | `{ slug: undefined }` |
| `pages/posts/[[...slug]].js` | `/posts/2023` | `{ slug: ['2023'] }` |
| `pages/posts/[[...slug]].js` | `/posts/2023/01/01` | `{ slug: ['2023', '01', '01'] }` |

### 9.2 路由守卫

可以在 `getServerSideProps` 或 `getStaticProps` 中实现路由守卫，控制页面访问权限。

```jsx
export async function getServerSideProps(context) {
  const { req } = context;
  const token = req.cookies.token;

  if (!token) {
    return {
      redirect: {
        destination: '/login',
        permanent: false,
      },
    };
  }

  return {
    props: {},
  };
}
```

### 9.3 重定向与改写

可以在 `next.config.js` 中配置重定向和改写规则。

```js
// next.config.js
module.exports = {
  async redirects() {
    return [
      // 重定向旧路由到新路由
      {
        source: '/old-page',
        destination: '/new-page',
        permanent: true,
      },
      // 条件重定向
      {
        source: '/blog/:slug',
        destination: '/posts/:slug',
        permanent: false,
      },
    ];
  },
  async rewrites() {
    return [
      // 改写 URL，隐藏真实路径
      {
        source: '/api',
        destination: 'https://api.example.com',
      },
    ];
  },
};
```

## 10. 总结

Next.js 的基于文件系统的路由机制简单直观，同时支持动态路由、嵌套路由等复杂场景。通过 `Link` 组件和 `useRouter` Hook，可以实现高效的客户端导航和路由控制。

路由是 Next.js 的核心特性之一，掌握路由系统对于开发 Next.js 应用至关重要。